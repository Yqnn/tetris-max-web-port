(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e={peter_wagner:{prefix:`peter_wagner`,segments:[`repeat`,`repeat`,`CD`,`repeat`,`repeat`,`E`,`E`,`Fa`,`Fb`,`Fc`,`repeat`,`repeat`,`E`,`Fb`,`G`],repeatSegment:0,folder:`music`},animal_instinct:{prefix:`animal_instinct`,segments:[`A`],repeatSegment:0,folder:`music`}},t={drop:`sounds/drop.wav`,stick:`sounds/stick.wav`,clear1:`sounds/clear1.wav`,clear2:`sounds/clear2.wav`,clear3:`sounds/clear3.wav`,clear4:`sounds/clear4.wav`,highscore:`sounds/highscore.wav`,smallBonus:`sounds/smallBonus.wav`,bigBonus:`sounds/bigBonus.wav`,newLevel:`sounds/newlevel.wav`,gameOver:`sounds/gameover.wav`,pause:`sounds/pause.wav`};const n=async n=>{try{let r=new window.AudioContext({latencyHint:`interactive`}),i={},a=[],o=[],s=0,c=0,l=0,u=null,d=null,f=!0,p=!0,m=!1;async function h(t){let n=e[t];o=n.segments,c=n.repeatSegment,l=n.segments.length-1;let i=[...new Set(o)],s={};for(let e of i)try{let t=await(await fetch(`${n.folder}/${n.prefix}_${e}.wav`)).arrayBuffer();s[e]=await r.decodeAudioData(t)}catch(t){console.log(`Failed to load music segment: ${e}`,t),s[e]=null}a=o.map(e=>s[e]||null)}async function g(e){e&&await h(e),!(!f||a.length===0)&&(r.state===`suspended`&&r.resume(),s=0,m=!0,_())}function _(){if(!m||!f)return;(s>=a.length||s<0)&&(s=c);let e=a[s];if(!e){s===l?s=c:s++,_();return}if(u)try{u.onended=null,u.stop()}catch{}u=r.createBufferSource(),u.buffer=e,d=r.createGain(),d.gain.value=.3,u.connect(d),d.connect(r.destination),u.onended=()=>{m&&f&&(s===l?s=c:s++,_())},u.start(0)}function v(){if(m=!1,u){try{u.onended=null,u.stop()}catch{}u=null}}function y(e){return f=!f,f?e&&g():v(),f}function b(){return p=!p,p}function x(e){if(!r||!i[e]||!p)return;r.state===`suspended`&&r.resume();let t=r.createBufferSource();t.buffer=i[e];let n=r.createGain();n.gain.value=.5,t.connect(n),n.connect(r.destination),t.start(r.currentTime+.01)}async function S(e){let n=Object.keys(t);for(let e of n){let n=t[e],a=await(await fetch(n)).arrayBuffer();i[e]=await r.decodeAudioData(a)}await h(e||`peter_wagner`)}return await S(n),{playSound:x,startMusic:g,stopMusic:v,getIsPlaying:()=>m,toggleMusic:y,toggleSound:b}}catch(e){return console.error(`Failed to initialize audio`,e),null}};var r={highScores:`sprites/highscores.png`,about:`sprites/about.png`,gameOver:`sprites/gameover.png`,pause:`sprites/pause.png`,welcome:`sprites/welcome.png`,scoreFrame:`sprites/score_frame.png`,levelFrame:`sprites/level_frame.png`,rowsFrame:`sprites/rows_frame.png`},i=[`level01.png`,`level02.png`,`level03.png`,`level04.png`,`level05.png`,`level06.png`,`level07.png`,`level08.png`,`level09.png`,`level10.png`],a=16;const o=[`default`,`pot_luck`],s=[`default`,`diamond`,`spherical`],c=e=>s.includes(e),l=e=>o.includes(e);var u=async()=>{let e=Object.entries(r).map(([e,t])=>new Promise((n,r)=>{let i=new Image;i.onload=()=>n([e,i]),i.onerror=()=>r(Error(`Could not load sprite ${e}`)),i.src=t}));return Object.fromEntries(await Promise.all(e))},d=async(e,t)=>{let n=i.map(n=>new Promise((r,i)=>{let a=new Image;a.onload=()=>{let e=document.createElement(`canvas`);e.width=a.width*t,e.height=a.height*t;let o=e.getContext(`2d`);if(!o){i(Error(`Could not get context for background ${n}`));return}o.imageSmoothingEnabled=!1,o.drawImage(a,0,0,e.width,e.height);let s=o.createPattern(e,`repeat`);if(!s){i(Error(`Could not create pattern for background ${n}`));return}r(s)},a.onerror=()=>{i(Error(`Could not load background ${n}`))},a.src=`backgrounds/${e}/${n}`}));return Promise.all(n)},f=async(e,t)=>{let n=[...Array(8)].map((n,r)=>new Promise((n,i)=>{let o=new Image;o.onload=()=>{let e=document.createElement(`canvas`);e.width=a*t,e.height=a*t;let s=e.getContext(`2d`);if(!s){i(Error(`Could not get context for piece ${r}`));return}s.imageSmoothingEnabled=!1,s.drawImage(o,r*a,0,a,a,0,0,a*t,a*t),n(e)},o.src=`pieces/${e}.png`}));return Promise.all(n)};const p=async(e,t,n)=>{let[r,i,a]=await Promise.all([u(),d(e,n),f(t,n)]);return{getMainSprite:e=>r[e],getBackgroundImage:e=>i[e],getPiecesImage:e=>a[e],setBackgroundImages:async e=>{i.splice(0,i.length,...await d(e,n))},setPiecesImage:async e=>{a.splice(0,a.length,...await f(e,n))}}},m={1:30,2:20,3:15,4:12,5:10,6:8,7:7,8:6,9:5,10:4},h={1:10,2:20,3:30,4:40,5:50,6:60,7:70,8:80,9:90,10:32e3},g=1e3/60,_=[[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]],[[0,0,0,0],[2,2,2,2],[0,0,0,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[3,3,3,0],[0,0,3,0]],[[0,0,0,0],[0,0,4,0],[4,4,4,0],[0,0,0,0]],[[0,0,0,0],[0,5,5,0],[5,5,0,0],[0,0,0,0]],[[0,0,0,0],[6,6,0,0],[0,6,6,0],[0,0,0,0]],[[0,0,0,0],[0,7,0,0],[0,7,7,0],[0,7,0,0]]].map((e,t)=>({height:21,offset:3,color:t,grid:e})),v=()=>{let e=y();return{start:t=>{e=y(),e.score.currentLevel=t,e.nextPiece=S(_[Math.floor(Math.random()*7)]),x(e),e.timing.lastDropTime=e.tick.count,e.tick.accumulator=0},tick:t=>{for(e.events=[],e.tick.accumulator+=t;e.tick.accumulator>=g;)e.tick.count++,e.tick.accumulator-=g,e.rowClearing.rowsToClear.length?e.tick.count-e.rowClearing.clearAnimStartTime>=10&&O(e):e.hardDrop.isHardDropping?j(e):b(e)},handleKeyDown:t=>A(e,t),handleKeyUp:t=>M(e,t),getScore:()=>e.score.currentScore,getLinesCleared:()=>e.score.linesCleared,getCurrentLevel:()=>e.score.currentLevel,getCurrentPiece:()=>e.currentPiece,getNextPiece:()=>e.nextPiece,getGameBoard:()=>e.board,getRowsToClear:()=>e.rowClearing.rowsToClear,isGameOver:()=>e.isGameOver,getEvents:()=>e.events}};function y(){let e=[];for(let t=0;t<10;t++){e[t]=[];for(let n=0;n<20;n++)e[t][n]=0}return{score:{currentScore:0,linesCleared:0,currentLevel:1},isGameOver:!1,events:[],board:e,currentPiece:null,nextPiece:null,timing:{lastDropTime:0,lastLeftTime:0,lastRightTime:0},movement:{zippingL:!1,zippingR:!1,zipNow:!1,inFreefall:!1,movePieceSlowly:!1,downKeyActive:!1,pushKeyActive:!1},rowClearing:{rowsToClear:[],clearAnimStartTime:0,clearAnimData:null},hardDrop:{isHardDropping:!1,hardDropStartTime:0},pendingDropScore:0,tick:{accumulator:0,count:0}}}function b(e){if(!e.currentPiece)return;let t=e.tick.count;t-e.timing.lastLeftTime>=10&&e.movement.zippingL&&!e.movement.zipNow&&(e.movement.zipNow=!0),t-e.timing.lastRightTime>=10&&e.movement.zippingR&&!e.movement.zipNow&&(e.movement.zipNow=!0),t-e.timing.lastLeftTime>=1&&e.movement.zippingL&&e.movement.zipNow&&(e.timing.lastLeftTime=t,e.currentPiece.offset--,T(e,e.currentPiece)||e.currentPiece.offset++),t-e.timing.lastRightTime>=1&&e.movement.zippingR&&e.movement.zipNow&&(e.timing.lastRightTime=t,e.currentPiece.offset++,T(e,e.currentPiece)||e.currentPiece.offset--);let n=!1,r=m[e.score.currentLevel];if(e.movement.inFreefall?n=t-e.timing.lastDropTime>=2:e.movement.movePieceSlowly?n=t-e.timing.lastDropTime>=15:(n=t-e.timing.lastDropTime>=r,e.score.currentLevel===10&&e.currentPiece.height%2==0&&(n=t-e.timing.lastDropTime>=r-1)),n){if(e.currentPiece.height--,e.movement.inFreefall&&(e.pendingDropScore+=1),T(e,e.currentPiece))e.movement.movePieceSlowly=!1;else if(e.currentPiece.height++,e.movement.movePieceSlowly||e.movement.inFreefall){let t=e.movement.inFreefall;e.movement.movePieceSlowly=!1,e.score.currentScore+=e.pendingDropScore,e.pendingDropScore=0,E(e,e.currentPiece)?D(e,t):e.isGameOver=!0}else e.movement.movePieceSlowly=!0;e.timing.lastDropTime=t}}function x(e){return e.nextPiece===null&&(e.nextPiece=S(_[Math.floor(Math.random()*7)])),e.currentPiece=e.nextPiece,e.currentPiece.height=21,e.currentPiece.offset=3,e.nextPiece=S(_[Math.floor(Math.random()*7)]),T(e,e.currentPiece)?(e.timing.lastDropTime=e.tick.count,!0):(e.isGameOver=!0,!1)}function S(e){let t={height:e.height,offset:e.offset,color:e.color,grid:[]};for(let n=0;n<4;n++)t.grid[n]=[...e.grid[n]];return t}function C(e,t){let n;switch(e){case 0:return;case 1:n=t[1][0],t[1][0]=t[0][2],t[0][2]=t[2][3],t[2][3]=t[3][1],t[3][1]=n,n=t[2][0],t[2][0]=t[0][1],t[0][1]=t[1][3],t[1][3]=t[3][2],t[3][2]=n,n=t[1][1],t[1][1]=t[1][2],t[1][2]=t[2][2],t[2][2]=t[2][1],t[2][1]=n;break;case 2:case 3:case 4:case 5:case 6:n=t[1][0],t[1][0]=t[1][2],t[1][2]=t[3][2],t[3][2]=t[3][0],t[3][0]=n,n=t[2][0],t[2][0]=t[1][1],t[1][1]=t[2][2],t[2][2]=t[3][1],t[3][1]=n;break}}function w(e,t){for(let n=0;n<3;n++)C(e,t)}function T(e,t){let n=t.offset,r=t.height;for(let i=0;i<4;i++)for(let a=0;a<4;a++)if(t.grid[i][a]&&(i+n>=10||i+n<0||r-a<0||r-a<20&&e.board[i+n][r-a]))return!1;return!0}function E(e,t){let n=!0;for(let r=0;r<4;r++)for(let i=0;i<4;i++)t.grid[r][i]&&(t.height-i<20?e.board[r+t.offset][t.height-i]=t.grid[r][i]:n=!1);return n}function D(e,t){let n=!1,r=[];t?e.events.push(`drop`):e.events.push(`stick`);for(let t=0;t<20;t++){let i=!0,a=0,o=!0;for(let n=0;n<10;n++){if(!e.board[n][t]){i=!1;break}a===0?a=e.board[n][t]:e.board[n][t]!==a&&(o=!1)}i&&(r.push(t),o&&(n=!0))}let i=r.length;i>0?(e.rowClearing.rowsToClear=r,e.rowClearing.clearAnimStartTime=e.tick.count,e.rowClearing.clearAnimData={dropped:i,bonus:n,wasDropOrFreefall:t},i===1?e.events.push(`clear1`):i===2?e.events.push(`clear2`):i===3?e.events.push(`clear3`):i===4&&e.events.push(`clear4`)):(k(e),x(e))}function O(e){if(!e.rowClearing.clearAnimData)return;let{dropped:t,bonus:n}=e.rowClearing.clearAnimData;t===1?e.score.currentScore+=100:t===2?e.score.currentScore+=300:t===3?e.score.currentScore+=600:t===4&&(e.score.currentScore+=1e3),e.rowClearing.rowsToClear.sort((e,t)=>t-e);for(let t of e.rowClearing.rowsToClear){for(let n=t;n<19;n++)for(let t=0;t<10;t++)e.board[t][n]=e.board[t][n+1];for(let t=0;t<10;t++)e.board[t][19]=0}e.score.linesCleared+=t;let r=!0,i=!1;for(let t=0;t<10&&r;t++)for(let n=0;n<20&&r;n++)e.board[t][n]&&(r=!1);r&&(i=!0,e.score.currentScore+=1e4,e.events.push(`bigBonus`)),n&&(e.score.currentScore+=2500,i||e.events.push(`smallBonus`)),e.score.linesCleared>=h[e.score.currentLevel]&&e.score.currentLevel<10&&(e.score.currentLevel++,!n&&!i&&e.events.push(`newLevel`)),e.rowClearing.rowsToClear=[],e.rowClearing.clearAnimData=null,k(e),x(e)}function k(e){e.movement.downKeyActive=!1,e.movement.pushKeyActive=!1,e.movement.inFreefall=!1,e.movement.zippingL=!1,e.movement.zippingR=!1,e.movement.zipNow=!1,e.movement.movePieceSlowly=!1,e.hardDrop.isHardDropping=!1}function A(e,t){t=t.toLowerCase(),!(e.hardDrop.isHardDropping||e.rowClearing.rowsToClear.length)&&(e.currentPiece&&(t===`k`&&(w(e.currentPiece.color,e.currentPiece.grid),T(e,e.currentPiece)||C(e.currentPiece.color,e.currentPiece.grid)),(t===`i`||t===`arrowup`)&&(C(e.currentPiece.color,e.currentPiece.grid),T(e,e.currentPiece)||w(e.currentPiece.color,e.currentPiece.grid)),t===`m`&&!e.movement.pushKeyActive&&(e.movement.inFreefall=!0,e.movement.pushKeyActive=!0,e.movement.zippingR=!1,e.movement.zippingL=!1,e.movement.zipNow=!1),(t===`j`||t===`arrowleft`)&&(e.movement.zippingR=!1,e.movement.zippingL||(e.movement.zippingL=!0,e.timing.lastLeftTime=e.tick.count,e.currentPiece.offset--,T(e,e.currentPiece)||e.currentPiece.offset++)),(t===`l`||t===`arrowright`)&&(e.movement.zippingL=!1,e.movement.zippingR||(e.movement.zippingR=!0,e.timing.lastRightTime=e.tick.count,e.currentPiece.offset++,T(e,e.currentPiece)||e.currentPiece.offset--))),(t===` `||t===`arrowdown`)&&!e.movement.downKeyActive&&!e.hardDrop.isHardDropping&&(e.movement.zippingR=!1,e.movement.zippingL=!1,e.movement.downKeyActive=!0,e.movement.movePieceSlowly=!1,e.hardDrop.isHardDropping=!0,e.hardDrop.hardDropStartTime=e.tick.count))}function j(e){if(!e.hardDrop.isHardDropping||!e.currentPiece)return;let t=e.tick.count;t-e.hardDrop.hardDropStartTime>=1&&(e.hardDrop.hardDropStartTime=t,e.currentPiece.height--,e.pendingDropScore+=1,T(e,e.currentPiece)||(--e.pendingDropScore,e.currentPiece.height++,e.hardDrop.isHardDropping=!1,e.score.currentScore+=e.pendingDropScore,e.pendingDropScore=0,E(e,e.currentPiece)?D(e,!0):e.isGameOver=!0,e.timing.lastDropTime=e.tick.count))}function M(e,t){t=t.toLowerCase(),(t===`j`||t===`arrowleft`)&&(e.movement.zippingL=!1,e.movement.zipNow=!1),(t===`l`||t===`arrowright`)&&(e.movement.zippingR=!1,e.movement.zipNow=!1),t===`m`&&(e.movement.inFreefall=!1,e.movement.pushKeyActive=!1),(t===` `||t===`arrowdown`)&&(e.movement.downKeyActive=!1)}function N(){let e=[];try{let t=localStorage.getItem(`tetrisMaxHighScores`);if(t)e=JSON.parse(t);else{e=[];for(let t=0;t<10;t++)e.push({name:`Anonymous`,score:0,rows:0,date:new Date(`1970-01-01`).toISOString()})}}catch(t){console.log(`Failed to load high scores:`,t),e=[]}return e}function P(e){try{localStorage.setItem(`tetrisMaxHighScores`,JSON.stringify(e))}catch(e){console.log(`Failed to save high scores:`,e)}}const F=(e,t)=>t>0&&e.findIndex(({score:e})=>t>=e)!==-1;function I(e,t){let n=e.findIndex(({score:e})=>t.score>=e),r={...t,date:new Date().toISOString()};for(let t=9;t>n;t--)e[t]=e[t-1];return e[n]=r,P(e),n}var L={WINDOW_WIDTH:500,WINDOW_HEIGHT:330,BLOCK_SIZE:16,BOARD_X:170,BOARD_Y:5,NEXT_X:24,NEXT_Y:4,NEXT_SIZE:96,SCORE_X:380,SCORE_Y:4,SCORE_WIDTH:96,SCORE_HEIGHT:60,SCORE_SPACING:20};const R=(e,t,n)=>{let r=L.BLOCK_SIZE*t,i=L.BLOCK_SIZE*t,a=L.BOARD_X*t,o=L.BOARD_Y*t,s=10*r,c=20*i,l=L.NEXT_X*t,u=L.NEXT_Y*t,d=L.NEXT_SIZE*t,f=L.SCORE_X*t,p=L.SCORE_Y*t,m=L.SCORE_HEIGHT*t,h=L.SCORE_SPACING*t;function g(){k.fillStyle=`rgb(255, 255, 0)`;for(let e of n.getRowsToClear()){let t=o+(19-e)*i;k.fillRect(a,t,s,i)}}function _(t){let r=A?.getBackgroundImage(n.getCurrentLevel()-1);r&&(k.fillStyle=r,k.fillRect(0,0,e.width,e.height)),v(),y(t),b(),t.isShowingHighScores&&O(t),t.isShowingAbout&&D(t)}function v(){k.fillStyle=`#000000`,k.fillRect(l,u,d,d),k.strokeStyle=`#FFFFFF`,k.lineWidth=t,k.strokeRect(l+1,u+1,d-2,d-2),k.fillStyle=`#FFFF00`,k.font=`${9*t}px Geneva, Helvetica, sans-serif`,k.fillText(`Next:`,l+3*t,u+12*t);let e=n.getNextPiece();if(e?.grid){let t=0,n=0;switch(e.color){case 1:t=r/2;break;case 2:t=-r,n=r/2;break;case 6:t=-r/2;break;case 3:case 4:case 5:n=r/2;break}let a=l+r+t,o=u+i+n;for(let t=0;t<4;t++)for(let n=0;n<4;n++)if(e.grid[t]&&e.grid[t][n]){let s=a+t*r,c=o+n*i,l=e.color,u=A?.getPiecesImage(l);l>=0&&l<7&&u&&k.drawImage(u,s,c,r,i)}}}function y({isShowingWelcomeScreen:e,isGameInProgress:r,isGamePaused:i}){if(e){x();return}k.fillStyle=`#000000`,k.fillRect(a,o,s,c),C(),n.getCurrentPiece()&&r&&!n.getRowsToClear().length&&w(),n.getRowsToClear().length&&g(),k.strokeStyle=`#FFFFFF`,k.lineWidth=t,k.strokeRect(a-1,o-1,s+2,c+2),i?S(`pause`):!r&&n.getCurrentPiece()&&S(`gameover`)}function b(){let e=[A?.getMainSprite(`scoreFrame`),A?.getMainSprite(`levelFrame`),A?.getMainSprite(`rowsFrame`)],r=[n.getScore(),n.getCurrentLevel(),n.getLinesCleared()],i=98*t,a=63*t;for(let n=0;n<3;n++){let o=p+n*(m+h),s=e[n];s?.complete&&k.drawImage(s,f,o,i,a),k.fillStyle=`#4E4E4E`,k.font=`${18*t}px Georgia, "Times New Roman", serif`,k.textAlign=`right`,k.fillText(String(r[n]),f+89*t,o+50*t)}k.textAlign=`left`}function x(){let e=A?.getMainSprite(`welcome`);e?.complete&&k.drawImage(e,a,o,s,c),k.strokeStyle=`#FFFFFF`,k.lineWidth=t,k.strokeRect(a-1,o-1,s+2,c+2)}function S(e){let t=a,n=o+7*i,r=s,c=5*i,l=A?.getMainSprite(e===`pause`?`pause`:`gameOver`);l?.complete&&k.drawImage(l,t,n,r,c)}function C(){let e=n.getGameBoard();if(e){for(let t=0;t<10;t++)if(e[t]){for(let n=0;n<20;n++)if(e[t][n]){let s=e[t][n]-1;s>=0&&s<7&&T(a+t*r,o+(19-n)*i,s)}}}}function w(){let e=n.getCurrentPiece();if(e?.grid){for(let t=0;t<4;t++)for(let n=0;n<4;n++)if(e.grid[t]&&e.grid[t][n]){let s=t+e.offset,c=e.height-n;if(c>=0&&c<20&&s>=0&&s<10){let l=e.grid[t][n]-1;l>=0&&l<7&&T(a+s*r,o+(19-c)*i,l)}}}}function T(e,t,n){let a=A?.getPiecesImage(n);a&&k.drawImage(a,e,t,r,i)}function E(e,n,r,i){k.fillStyle=`#000000`,k.fillRect(e+2*t,n+2*t,r-t,i-t),k.fillRect(e,n,r,i);let a={topLeft:[`#000000`,`#BBBBBB`,`#FFFFFF`],bottomRight:[`#000000`,`#555555`,`#999999`]};for(let o=0;o<3;o++){let s=o;k.fillStyle=a.topLeft[o],k.fillRect(e+s*t,n+s*t,r-s*2*t,t),k.fillRect(e+s*t,n+s*t,t,i-s*2*t),k.fillStyle=a.bottomRight[o],k.fillRect(e+(s+1)*t,n+i-s*t-t,r-(s*2+1)*t,t),k.fillRect(e+r-s*t-t,n+(s+1)*t,t,i-(s*2+1)*t)}k.fillStyle=a.topLeft[1],k.fillRect(r+e-3*t,n+2*t,t,t),k.fillRect(e+2*t,i+n-3*t,t,t)}function D({isShowingAbout:n}){if(!n)return;let r=477*t,i=244*t,a=r+6*t+6*t,o=i+6*t+6*t,s=t*Math.floor((e.width-a)/2/t),c=t*Math.floor((e.height-o)/2/t);E(s,c,a,o);let l=s+3*t+3*t,u=c+3*t+3*t,d=A?.getMainSprite(`about`);d?.complete&&k.drawImage(d,l,u,r,i)}function O({isShowingHighScores:n,lastHighScoreIndex:r,highScores:i}){if(!n)return;let a=452*t,o=308*t,s=(e.width-a)/2,c=(e.height-o)/2;E(s,c,a,o),k.fillStyle=`#000000`,k.fillRect(s+3*t,c+3*t,a-6*t,o-6*t);let l=3*t,u=s+l,d=c+l,f=A?.getMainSprite(`highScores`);if(f?.complete){let e=u+109*t+3*t,n=d+3*t;k.drawImage(f,e,n,220*t,50*t)}k.fillStyle=`#FFFFFF`,k.font=`${15*t}px "Times New Roman", serif`;let p=d+62*t,m=22*t,h=u+14*t,g=u+256*t,_=u+320*t,v=u+335*t;k.textAlign=`left`,k.fillText(`Name`,h,p);let{width:y}=k.measureText(`Name`);k.fillRect(h,p+t,y,t),k.textAlign=`right`,k.fillText(`Score`,g,p);let{width:b}=k.measureText(`Score`);k.fillRect(g-b,p+t,b,t),k.fillText(`Rows`,_,p);let{width:x}=k.measureText(`Rows`);k.fillRect(_-x,p+t,x,t),k.textAlign=`left`,k.fillText(`Date`,v,p);let{width:S}=k.measureText(`Date`);k.fillRect(v,p+t,S,t),k.font=`${15*t}px "Times New Roman", serif`;for(let e=0;e<10;e++){let n=i[e],a=p+(e+1)*m+3*t;e===r?k.fillStyle=`#FFFF00`:k.fillStyle=`#FFFFFF`,k.textAlign=`left`,k.fillText(`${e+1}. ${n.name}`,h,a),k.textAlign=`right`,k.fillText(String(n.score),g,a),k.fillText(String(n.rows),_,a),k.textAlign=`left`,k.fillText(B(n.date),v,a)}k.textAlign=`left`}let k=z(e),A=null;return e.width=L.WINDOW_WIDTH*t,e.height=L.WINDOW_HEIGHT*t,k.imageSmoothingEnabled=!1,k.fillStyle=`#000000`,k.fillRect(0,0,e.width,e.height),k.fillStyle=`#FFFFFF`,k.font=`${12*t}px Geneva, Helvetica, sans-serif`,k.fillText(`Loading assets...`,20,e.height/2),{drawWindow:_,setSprites:e=>A=e}};function z(e){let t=e.getContext(`2d`);if(!t)throw Error(`Could not get context`);return t}function B(e){try{return new Date(e).toLocaleDateString(`en-UK`,{month:`2-digit`,day:`2-digit`,year:`2-digit`})}catch{return`--`}}function V(e){return document.getElementById(e)}function H(e){return document.getElementById(e)}function U(e){return document.getElementById(e)}function W(e){return document.getElementById(e)}function G(){return document.getElementById(`gameCanvas`)}const K=e=>{H(`startBtn`).textContent=e===`ready`?`Begin Game`:`Restart`,H(`pauseBtn`).disabled=e===`ready`,H(`pauseBtn`).textContent=e===`paused`?`Resume`:`Pause`,V(`levelSelect`).disabled=e!==`ready`},q=e=>{let t=W(`highScoreModalOverlay`);t.removeAttribute(`hidden`);let n=U(`highScoreNameInput`);n.value=`Player`,n.focus(),n.select(),H(`startBtn`).disabled=!0;let r=()=>{e(n.value&&n.value.trim()?n.value.trim().substring(0,20):`Anonymous`),t.setAttribute(`hidden`,``),H(`startBtn`).disabled=!1,o.removeEventListener(`click`,r),n.removeEventListener(`keydown`,i),t.removeEventListener(`click`,a)},i=e=>{e.key===`Enter`&&r()},a=e=>{e.target===t&&r()},o=H(`highScoreModalOk`);o.addEventListener(`click`,r),n.addEventListener(`keydown`,i),t.addEventListener(`click`,a)},J=({onPause:e,onKeyUp:t,onKeyDown:n,onClick:r,onStart:i,onToggleMusic:a,onToggleSound:o,onShowHighScores:s,onShowAbout:u,onSelectLevel:d,onSelectPieces:f,onSelectBackground:p,onSelectMusic:m})=>{document.addEventListener(`keydown`,t=>{if(W(`highScoreModalOverlay`).hasAttribute(`hidden`)){if([`ArrowLeft`,`ArrowRight`,`ArrowDown`,`ArrowUp`,`Space`,`KeyJ`,`KeyL`,`KeyK`,`KeyI`,`KeyM`,`KeyP`].includes(t.code)&&t.preventDefault(),t.code===`KeyP`){e();return}n(t.key)}}),document.addEventListener(`keyup`,e=>{t(e.key)}),G().addEventListener(`click`,r),H(`startBtn`).addEventListener(`click`,i),H(`pauseBtn`).addEventListener(`click`,e),H(`musicBtn`).addEventListener(`click`,()=>{let e=a();H(`musicBtn`).textContent=e?`Music: ON`:`Music: OFF`}),H(`soundBtn`).addEventListener(`click`,()=>{let e=o();H(`soundBtn`).textContent=e?`Sound Effects: ON`:`Sound Effects: OFF`}),H(`highScoresBtn`).addEventListener(`click`,s),H(`aboutBtn`).addEventListener(`click`,u),V(`levelSelect`).addEventListener(`change`,e=>{let t=e?.target?.value;t&&d(parseInt(t))}),V(`piecesSelect`).addEventListener(`change`,e=>{let t=e?.target?.value;c(t)&&f(t)}),V(`backgroundSelect`).addEventListener(`change`,e=>{let t=e?.target?.value;l(t)&&p(t)}),V(`musicSelect`).addEventListener(`change`,e=>{let t=e?.target?.value;(t===`peter_wagner`||t===`animal_instinct`)&&m(t)})};var Y=2;async function X(){let e=`default`,t=`default`,r=`peter_wagner`,i=1,a=[],o=-1,s=!1,c=!1,l=!1,u=!1,d=!0,f=0,m=v(),h=R(G(),Y,m),g=await p(t,e,Y);h.setSprites(g);let _=await n(r);a=N();let y=()=>{u=!0,K(`paused`),_?.stopMusic()};J({onStart:()=>{m.start(i),_?.startMusic(r),s=!1,c=!1,f=performance.now(),l=!0,u=!1,d=!1,K(`running`)},onPause:()=>{l&&(u?(u=!1,K(`running`),s=!1,c=!1,_?.startMusic(r),f=performance.now()):(_?.playSound(`pause`),y()))},onKeyUp:e=>m.handleKeyUp(e),onKeyDown:e=>m.handleKeyDown(e),onClick:()=>{s=!1,c=!1},onToggleMusic:()=>_?.toggleMusic(l&&!u)??!1,onToggleSound:()=>_?.toggleSound()??!1,onShowHighScores:()=>{s?s=!1:(c=!1,o=-1,s=!0,l&&!u&&y())},onShowAbout:()=>{c?c=!1:(s=!1,c=!0,l&&!u&&y())},onSelectLevel:e=>{i=e},onSelectPieces:t=>{e=t,g.setPiecesImage(e)},onSelectBackground:e=>{t=e,g.setBackgroundImages(t)},onSelectMusic:e=>{r=e;let t=_?.getIsPlaying();t&&_?.stopMusic(),t&&l&&!u&&_?.startMusic(r)}});let b=()=>{l=!1,K(`ready`),_?.stopMusic(),_?.playSound(`gameOver`),F(a,m.getScore())&&setTimeout(()=>{_?.playSound(`highscore`),q(e=>{o=I(a,{name:e,score:m.getScore(),rows:m.getLinesCleared()}),s=!0})},1e3)},x=e=>{if(l&&!u){let t=e-f;f=e,m.tick(t);for(let e of m.getEvents())_?.playSound(e);m.isGameOver()&&b()}h.drawWindow({isShowingHighScores:s,lastHighScoreIndex:o,isShowingWelcomeScreen:d,isShowingAbout:c,isGameInProgress:l,isGamePaused:u,highScores:a}),requestAnimationFrame(x)};requestAnimationFrame(x)}document.addEventListener(`DOMContentLoaded`,X);