(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e={peter_wagner:{prefix:`peter_wagner`,segments:[`repeat`,`repeat`,`CD`,`repeat`,`repeat`,`E`,`E`,`Fa`,`Fb`,`Fc`,`repeat`,`repeat`,`E`,`Fb`,`G`],repeatSegment:0,folder:`music`},animal_instinct:{prefix:`animal_instinct`,segments:[`A`],repeatSegment:0,folder:`music`}},t={drop:`sounds/drop.wav`,stick:`sounds/stick.wav`,clear1:`sounds/clear1.wav`,clear2:`sounds/clear2.wav`,clear3:`sounds/clear3.wav`,clear4:`sounds/clear4.wav`,highscore:`sounds/highscore.wav`,smallBonus:`sounds/smallBonus.wav`,bigBonus:`sounds/bigBonus.wav`,newLevel:`sounds/newlevel.wav`,gameOver:`sounds/gameover.wav`,pause:`sounds/pause.wav`};const n=async(n,r,i)=>{try{let a=new window.AudioContext({latencyHint:`interactive`}),o={},s=[],c=[],l=0,u=0,d=0,f=null,p=null,m=r,h=i,g=!1;async function _(t){let n=e[t];c=n.segments,u=n.repeatSegment,d=n.segments.length-1;let r=[...new Set(c)],i={};for(let e of r)try{let t=await(await fetch(`${n.folder}/${n.prefix}_${e}.wav`)).arrayBuffer();i[e]=await a.decodeAudioData(t)}catch(t){console.log(`Failed to load music segment: ${e}`,t),i[e]=null}s=c.map(e=>i[e]||null)}async function v(e){e&&await _(e),!(!m||s.length===0)&&(a.state===`suspended`&&a.resume(),l=0,g=!0,y())}function y(){if(!g||!m)return;(l>=s.length||l<0)&&(l=u);let e=s[l];if(!e){l===d?l=u:l++,y();return}if(f)try{f.onended=null,f.stop()}catch{}f=a.createBufferSource(),f.buffer=e,p=a.createGain(),p.gain.value=.3,f.connect(p),p.connect(a.destination),f.onended=()=>{g&&m&&(l===d?l=u:l++,y())},f.start(0)}function b(){if(g=!1,f){try{f.onended=null,f.stop()}catch{}f=null}}function x(e){return m=!m,m?e&&v():b(),m}function S(){return h=!h,h}function C(e){if(!a||!o[e]||!h)return;a.state===`suspended`&&a.resume();let t=a.createBufferSource();t.buffer=o[e];let n=a.createGain();n.gain.value=.5,t.connect(n),n.connect(a.destination),t.start(a.currentTime+.01)}async function w(e){let n=Object.keys(t);for(let e of n){let n=t[e],r=await(await fetch(n)).arrayBuffer();o[e]=await a.decodeAudioData(r)}await _(e||`peter_wagner`)}return await w(n),{playSound:C,startMusic:v,stopMusic:b,getIsPlaying:()=>g,toggleMusic:x,toggleSound:S}}catch(e){return console.error(`Failed to initialize audio`,e),null}};var r={highScores:`sprites/highscores.png`,about:`sprites/about.png`,gameOver:`sprites/gameover.png`,pause:`sprites/pause.png`,welcome:`sprites/welcome.png`,scoreFrame:`sprites/score_frame.png`,levelFrame:`sprites/level_frame.png`,rowsFrame:`sprites/rows_frame.png`},i={...r,gameOver:`sprites/gameover_lg.png`,pause:`sprites/pause_lg.png`,welcome:`sprites/welcome_lg.png`},a={highScores:`sprites/highscores_bw.png`,about:`sprites/about_bw.png`,gameOver:`sprites/gameover_bw.png`,pause:`sprites/paused_bw.png`,welcome:`sprites/welcome_bw.png`,scoreFrame:`sprites/frame_bw.png`,levelFrame:`sprites/frame_bw.png`,rowsFrame:`sprites/frame_bw.png`},o=[`level01.png`,`level02.png`,`level03.png`,`level04.png`,`level05.png`,`level06.png`,`level07.png`,`level08.png`,`level09.png`,`level10.png`],s=16,c=22;const l=[`default`,`pot_luck`],u=[`default`,`diamond`,`spherical`],d=e=>u.includes(e),f=e=>l.includes(e);var p=e=>e===`bw`?a:e===`fullscreen`||e===`mobile`?i:r,m=async e=>{let t=Object.entries(p(e)).map(([e,t])=>new Promise((n,r)=>{let i=new Image;i.onload=()=>n([e,i]),i.onerror=()=>r(Error(`Could not load sprite ${e}`)),i.src=t}));return Object.fromEntries(await Promise.all(t))},h=async(e,t)=>{let n=o.map(n=>new Promise((r,i)=>{let a=new Image;a.onload=()=>{let e=document.createElement(`canvas`);e.width=a.width*t,e.height=a.height*t;let o=e.getContext(`2d`);if(!o){i(Error(`Could not get context for background ${n}`));return}o.imageSmoothingEnabled=!1,o.drawImage(a,0,0,e.width,e.height);let s=o.createPattern(e,`repeat`);if(!s){i(Error(`Could not create pattern for background ${n}`));return}r(s)},a.onerror=()=>{i(Error(`Could not load background ${n}`))},a.src=`backgrounds/${e}/${n}`}));return Promise.all(n)},g=e=>{let t=document.createElement(`canvas`);t.width=8*e,t.height=8*e;let n=t.getContext(`2d`);if(!n)throw Error(`Could not get context for BW background`);n.fillStyle=`#000000`,n.fillRect(0,0,t.width,t.height),n.fillStyle=`#FFFFFF`,n.fillRect(2*e,0*e,e,e),n.fillRect(4*e,1*e,e,e),n.fillRect(1*e,2*e,e,e),n.fillRect(6*e,4*e,e,e);let r=n.createPattern(t,`repeat`);if(!r)throw Error(`Could not create BW background pattern`);return Array(10).fill(r)},_=async(e,t,n)=>{let r=n===`bw`,i=(n===`fullscreen`||n===`mobile`)&&e===`default`,a,o;r?(a=`sprites/default_pieces_bw.png`,o=s):i?(a=`sprites/default_pieces_lg.png`,o=c):(a=`pieces/${e}.png`,o=s);let l=[...Array(8)].map((e,n)=>new Promise((e,r)=>{let i=new Image;i.onload=()=>{let a=document.createElement(`canvas`);a.width=o*t,a.height=o*t;let s=a.getContext(`2d`);if(!s){r(Error(`Could not get context for piece ${n}`));return}s.imageSmoothingEnabled=!1,s.drawImage(i,n*o,0,o,o,0,0,o*t,o*t),e(a)},i.onerror=()=>r(Error(`Could not load pieces ${a}`)),i.src=a}));return Promise.all(l)};const v=async(e,t,n,r=`window`)=>{let i=r===`bw`?Promise.resolve(g(n)):h(e,n),[a,o,s]=await Promise.all([m(r),i,_(t,n,r)]),c=r;return{getMainSprite:e=>a[e],getBackgroundImage:e=>o[e],getPiecesImage:e=>s[e],setBackgroundImages:async e=>{c!==`bw`&&o.splice(0,o.length,...await h(e,n))},setPiecesImage:async e=>{s.splice(0,s.length,...await _(e,n,c))},setDisplayMode:async(e,t)=>{c=e;let r=e===`bw`?g(n):await h(`default`,n),[i,l]=await Promise.all([m(e),_(t,n,e)]);for(let e of Object.keys(i))a[e]=i[e];s.splice(0,s.length,...l),o.splice(0,o.length,...r)}}},y={1:30,2:20,3:15,4:12,5:10,6:8,7:7,8:6,9:5,10:4},b={1:10,2:20,3:30,4:40,5:50,6:60,7:70,8:80,9:90,10:32e3},x=1e3/60,S=[[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]],[[0,0,0,0],[2,2,2,2],[0,0,0,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[3,3,3,0],[0,0,3,0]],[[0,0,0,0],[0,0,4,0],[4,4,4,0],[0,0,0,0]],[[0,0,0,0],[0,5,5,0],[5,5,0,0],[0,0,0,0]],[[0,0,0,0],[6,6,0,0],[0,6,6,0],[0,0,0,0]],[[0,0,0,0],[0,7,0,0],[0,7,7,0],[0,7,0,0]]].map((e,t)=>({height:21,offset:3,color:t,grid:e})),C=()=>{let e=w(!0);return{start:t=>{e=w(),e.score.level=t,e.nextPiece=D(S[Math.floor(Math.random()*7)]),E(e),e.timing.lastDropTime=e.tick.count,e.tick.accumulator=0},tick:t=>{for(e.events=[],e.tick.accumulator+=t;e.tick.accumulator>=x;)e.tick.count++,e.tick.accumulator-=x,e.rowClearing.rowsToClear.length?e.tick.count-e.rowClearing.clearAnimStartTime>=10&&N(e):e.hardDrop.isHardDropping?te(e):T(e)},saveState:()=>{let t={score:e.score,board:e.board,currentPiece:e.currentPiece,nextPiece:e.nextPiece,pendingDropScore:e.pendingDropScore};localStorage.setItem(`tetrisMaxGameState`,JSON.stringify(t))},handleKeyDown:t=>ee(e,t),handleKeyUp:t=>ne(e,t),getScore:()=>e.score.currentScore,getLinesCleared:()=>e.score.linesCleared,getCurrentLevel:()=>e.score.level,getCurrentPiece:()=>e.currentPiece,getNextPiece:()=>e.nextPiece,getGameBoard:()=>e.board,getRowsToClear:()=>e.rowClearing.rowsToClear,isGameOver:()=>e.isGameOver,getEvents:()=>e.events}};function w(e=!1){let t=[];for(let e=0;e<10;e++){t[e]=[];for(let n=0;n<20;n++)t[e][n]=0}let n=e?localStorage.getItem(`tetrisMaxGameState`):null;return localStorage.removeItem(`tetrisMaxGameState`),{score:{currentScore:0,linesCleared:0,level:1},isGameOver:!1,events:[],board:t,currentPiece:null,nextPiece:null,timing:{lastDropTime:0,lastLeftTime:0,lastRightTime:0},movement:{zippingL:!1,zippingR:!1,zipNow:!1,inFreefall:!1,movePieceSlowly:!1,downKeyActive:!1,pushKeyActive:!1},rowClearing:{rowsToClear:[],clearAnimStartTime:0,clearAnimData:null},hardDrop:{isHardDropping:!1,hardDropStartTime:0},pendingDropScore:0,tick:{accumulator:0,count:0},...n?JSON.parse(n):{}}}function T(e){if(!e.currentPiece)return;let t=e.tick.count;t-e.timing.lastLeftTime>=10&&e.movement.zippingL&&!e.movement.zipNow&&(e.movement.zipNow=!0),t-e.timing.lastRightTime>=10&&e.movement.zippingR&&!e.movement.zipNow&&(e.movement.zipNow=!0),t-e.timing.lastLeftTime>=1&&e.movement.zippingL&&e.movement.zipNow&&(e.timing.lastLeftTime=t,e.currentPiece.offset--,A(e,e.currentPiece)||e.currentPiece.offset++),t-e.timing.lastRightTime>=1&&e.movement.zippingR&&e.movement.zipNow&&(e.timing.lastRightTime=t,e.currentPiece.offset++,A(e,e.currentPiece)||e.currentPiece.offset--);let n=!1,r=y[e.score.level];if(e.movement.inFreefall?n=t-e.timing.lastDropTime>=2:e.movement.movePieceSlowly?n=t-e.timing.lastDropTime>=15:(n=t-e.timing.lastDropTime>=r,e.score.level===10&&e.currentPiece.height%2==0&&(n=t-e.timing.lastDropTime>=r-1)),n){if(e.currentPiece.height--,e.movement.inFreefall&&(e.pendingDropScore+=1),A(e,e.currentPiece))e.movement.movePieceSlowly=!1;else if(e.currentPiece.height++,e.movement.movePieceSlowly||e.movement.inFreefall){let t=e.movement.inFreefall;e.movement.movePieceSlowly=!1,e.score.currentScore+=e.pendingDropScore,e.pendingDropScore=0,j(e,e.currentPiece)?M(e,t):e.isGameOver=!0}else e.movement.movePieceSlowly=!0;e.timing.lastDropTime=t}}function E(e){return e.nextPiece===null&&(e.nextPiece=D(S[Math.floor(Math.random()*7)])),e.currentPiece=e.nextPiece,e.currentPiece.height=21,e.currentPiece.offset=3,e.nextPiece=D(S[Math.floor(Math.random()*7)]),A(e,e.currentPiece)?(e.timing.lastDropTime=e.tick.count,!0):(e.isGameOver=!0,!1)}function D(e){let t={height:e.height,offset:e.offset,color:e.color,grid:[]};for(let n=0;n<4;n++)t.grid[n]=[...e.grid[n]];return t}function O(e,t){let n;switch(e){case 0:return;case 1:n=t[1][0],t[1][0]=t[0][2],t[0][2]=t[2][3],t[2][3]=t[3][1],t[3][1]=n,n=t[2][0],t[2][0]=t[0][1],t[0][1]=t[1][3],t[1][3]=t[3][2],t[3][2]=n,n=t[1][1],t[1][1]=t[1][2],t[1][2]=t[2][2],t[2][2]=t[2][1],t[2][1]=n;break;case 2:case 3:case 4:case 5:case 6:n=t[1][0],t[1][0]=t[1][2],t[1][2]=t[3][2],t[3][2]=t[3][0],t[3][0]=n,n=t[2][0],t[2][0]=t[1][1],t[1][1]=t[2][2],t[2][2]=t[3][1],t[3][1]=n;break}}function k(e,t){for(let n=0;n<3;n++)O(e,t)}function A(e,t){let n=t.offset,r=t.height;for(let i=0;i<4;i++)for(let a=0;a<4;a++)if(t.grid[i][a]&&(i+n>=10||i+n<0||r-a<0||r-a<20&&e.board[i+n][r-a]))return!1;return!0}function j(e,t){let n=!0;for(let r=0;r<4;r++)for(let i=0;i<4;i++)t.grid[r][i]&&(t.height-i<20?e.board[r+t.offset][t.height-i]=t.grid[r][i]:n=!1);return n}function M(e,t){let n=!1,r=[];t?e.events.push(`drop`):e.events.push(`stick`);for(let t=0;t<20;t++){let i=!0,a=0,o=!0;for(let n=0;n<10;n++){if(!e.board[n][t]){i=!1;break}a===0?a=e.board[n][t]:e.board[n][t]!==a&&(o=!1)}i&&(r.push(t),o&&(n=!0))}let i=r.length;i>0?(e.rowClearing.rowsToClear=r,e.rowClearing.clearAnimStartTime=e.tick.count,e.rowClearing.clearAnimData={dropped:i,bonus:n,wasDropOrFreefall:t},i===1?e.events.push(`clear1`):i===2?e.events.push(`clear2`):i===3?e.events.push(`clear3`):i===4&&e.events.push(`clear4`)):(P(e),E(e))}function N(e){if(!e.rowClearing.clearAnimData)return;let{dropped:t,bonus:n}=e.rowClearing.clearAnimData;t===1?e.score.currentScore+=100:t===2?e.score.currentScore+=300:t===3?e.score.currentScore+=600:t===4&&(e.score.currentScore+=1e3),e.rowClearing.rowsToClear.sort((e,t)=>t-e);for(let t of e.rowClearing.rowsToClear){for(let n=t;n<19;n++)for(let t=0;t<10;t++)e.board[t][n]=e.board[t][n+1];for(let t=0;t<10;t++)e.board[t][19]=0}e.score.linesCleared+=t;let r=!0,i=!1;for(let t=0;t<10&&r;t++)for(let n=0;n<20&&r;n++)e.board[t][n]&&(r=!1);r&&(i=!0,e.score.currentScore+=1e4,e.events.push(`bigBonus`)),n&&(e.score.currentScore+=2500,i||e.events.push(`smallBonus`)),e.score.linesCleared>=b[e.score.level]&&e.score.level<10&&(e.score.level++,!n&&!i&&e.events.push(`newLevel`)),e.rowClearing.rowsToClear=[],e.rowClearing.clearAnimData=null,P(e),E(e)}function P(e){e.movement.downKeyActive=!1,e.movement.pushKeyActive=!1,e.movement.inFreefall=!1,e.movement.zippingL=!1,e.movement.zippingR=!1,e.movement.zipNow=!1,e.movement.movePieceSlowly=!1,e.hardDrop.isHardDropping=!1}function ee(e,t){t=t.toLowerCase(),!(e.hardDrop.isHardDropping||e.rowClearing.rowsToClear.length)&&(e.currentPiece&&(t===`k`&&(k(e.currentPiece.color,e.currentPiece.grid),A(e,e.currentPiece)||O(e.currentPiece.color,e.currentPiece.grid)),(t===`i`||t===`arrowup`)&&(O(e.currentPiece.color,e.currentPiece.grid),A(e,e.currentPiece)||k(e.currentPiece.color,e.currentPiece.grid)),t===`m`&&!e.movement.pushKeyActive&&(e.movement.inFreefall=!0,e.movement.pushKeyActive=!0,e.movement.zippingR=!1,e.movement.zippingL=!1,e.movement.zipNow=!1),(t===`j`||t===`arrowleft`)&&(e.movement.zippingR=!1,e.movement.zippingL||(e.movement.zippingL=!0,e.timing.lastLeftTime=e.tick.count,e.currentPiece.offset--,A(e,e.currentPiece)||e.currentPiece.offset++)),(t===`l`||t===`arrowright`)&&(e.movement.zippingL=!1,e.movement.zippingR||(e.movement.zippingR=!0,e.timing.lastRightTime=e.tick.count,e.currentPiece.offset++,A(e,e.currentPiece)||e.currentPiece.offset--))),(t===` `||t===`arrowdown`)&&!e.movement.downKeyActive&&!e.hardDrop.isHardDropping&&(e.movement.zippingR=!1,e.movement.zippingL=!1,e.movement.downKeyActive=!0,e.movement.movePieceSlowly=!1,e.hardDrop.isHardDropping=!0,e.hardDrop.hardDropStartTime=e.tick.count))}function te(e){if(!e.hardDrop.isHardDropping||!e.currentPiece)return;let t=e.tick.count;t-e.hardDrop.hardDropStartTime>=1&&(e.hardDrop.hardDropStartTime=t,e.currentPiece.height--,e.pendingDropScore+=1,A(e,e.currentPiece)||(--e.pendingDropScore,e.currentPiece.height++,e.hardDrop.isHardDropping=!1,e.score.currentScore+=e.pendingDropScore,e.pendingDropScore=0,j(e,e.currentPiece)?M(e,!0):e.isGameOver=!0,e.timing.lastDropTime=e.tick.count))}function ne(e,t){t=t.toLowerCase(),(t===`j`||t===`arrowleft`)&&(e.movement.zippingL=!1,e.movement.zipNow=!1),(t===`l`||t===`arrowright`)&&(e.movement.zippingR=!1,e.movement.zipNow=!1),t===`m`&&(e.movement.inFreefall=!1,e.movement.pushKeyActive=!1),(t===` `||t===`arrowdown`)&&(e.movement.downKeyActive=!1)}function re(){let e=[];try{let t=localStorage.getItem(`tetrisMaxHighScores`);if(t)e=JSON.parse(t);else{e=[];for(let t=0;t<10;t++)e.push({name:`Anonymous`,score:0,rows:0,date:new Date(`1970-01-01`).toISOString()})}}catch(t){console.log(`Failed to load high scores:`,t),e=[]}return e}function F(e){try{localStorage.setItem(`tetrisMaxHighScores`,JSON.stringify(e))}catch(e){console.log(`Failed to save high scores:`,e)}}const I=(e,t)=>t>0&&e.findIndex(({score:e})=>t>=e)!==-1;function L(e,t){let n=e.findIndex(({score:e})=>t.score>=e),r={...t,date:new Date().toISOString()};for(let t=9;t>n;t--)e[t]=e[t-1];return e[n]=r,F(e),n}const R=(e,t,n,r,i=`window`)=>{let a=0,o=0,s=0,c=0,l=0,u=0,d=0,f=0,p=0,m=0,h=0,g=0,_=0,v=i===`bw`;function y(n){a=n.BLOCK_SIZE*t,o=n.BLOCK_SIZE*t,s=n.BOARD_X*t,c=n.BOARD_Y*t,l=10*a,u=20*o,d=n.NEXT_X*t,f=n.NEXT_Y*t,p=n.NEXT_SIZE*t,m=n.SCORE_X*t,h=n.SCORE_Y*t,g=n.SCORE_HEIGHT*t,_=n.SCORE_SPACING*t,e.width=n.WINDOW_WIDTH*t,e.height=n.WINDOW_HEIGHT*t,N.imageSmoothingEnabled=!1}function b(){N.fillStyle=v?`#FFFFFF`:`rgb(255, 255, 0)`;for(let e of n.getRowsToClear()){let t=c+(19-e)*o;N.fillRect(s,t,l,o)}}function x(t){let r=P?.getBackgroundImage(n.getCurrentLevel()-1);r&&(N.fillStyle=r,N.fillRect(0,0,e.width,e.height)),S(),C(t),w(),t.isShowingHighScores&&M(t),t.isShowingAbout&&j(t)}function S(){N.fillStyle=`#000000`,N.fillRect(d,f,p,p),N.strokeStyle=`#FFFFFF`,N.lineWidth=t,N.strokeRect(d+1,f+1,p-2,p-2),N.fillStyle=v?`#FFFFFF`:`#FFFF00`,N.font=`${9*t}px Geneva, Helvetica, sans-serif`,N.fillText(`Next:`,d+3*t,f+12*t);let e=n.getNextPiece();if(e?.grid){let t=0,n=0;switch(e.color){case 1:t=a/2;break;case 2:t=-a,n=a/2;break;case 6:t=-a/2;break;case 3:case 4:case 5:n=a/2;break}let r=d+a+t,i=f+o+n;for(let t=0;t<4;t++)for(let n=0;n<4;n++)if(e.grid[t]&&e.grid[t][n]){let s=r+t*a,c=i+n*o,l=e.color,u=P?.getPiecesImage(l);l>=0&&l<7&&u&&N.drawImage(u,s,c,a,o)}}}function C({isShowingWelcomeScreen:e,isGameInProgress:r,isGamePaused:i}){if(e){T();return}N.fillStyle=`#000000`,N.fillRect(s,c,l,u),D(),n.getCurrentPiece()&&!n.getRowsToClear().length&&O(),n.getRowsToClear().length&&b(),N.strokeStyle=`#FFFFFF`,N.lineWidth=t,N.strokeRect(s-1,c-1,l+2,u+2),i?E(`pause`):!r&&n.getCurrentPiece()&&E(`gameover`)}function w(){let e=[P?.getMainSprite(`scoreFrame`),P?.getMainSprite(`levelFrame`),P?.getMainSprite(`rowsFrame`)],r=[n.getScore(),n.getCurrentLevel(),n.getLinesCleared()],i=[`score`,`level`,`rows`],a=98*t,o=63*t;for(let n=0;n<3;n++){let s=h+n*(g+_),c=e[n];if(c?.complete&&N.drawImage(c,m,s,a,o),v){N.fillStyle=`#000000`,N.font=`bold ${14*t}px Georgia, "Times New Roman", serif`,N.textAlign=`left`;let e=n===0?25:30;N.fillText(i[n],m+e*t,s+20*t)}N.fillStyle=v?`#FFFFFF`:`#4E4E4E`,N.font=`${18*t}px Georgia, "Times New Roman", serif`,N.textAlign=`right`,N.fillText(String(r[n]),m+89*t,s+50*t)}N.textAlign=`left`}function T(){let e=P?.getMainSprite(`welcome`);e?.complete&&N.drawImage(e,s,c,l,u),N.strokeStyle=`#FFFFFF`,N.lineWidth=t,N.strokeRect(s-1,c-1,l+2,u+2)}function E(e){let t=s,n=c+7*o,r=l,i=5*o,a=P?.getMainSprite(e===`pause`?`pause`:`gameOver`);a?.complete&&N.drawImage(a,t,n,r,i)}function D(){let e=n.getGameBoard();if(e){for(let t=0;t<10;t++)if(e[t]){for(let n=0;n<20;n++)if(e[t][n]){let r=e[t][n]-1;r>=0&&r<7&&k(s+t*a,c+(19-n)*o,r)}}}}function O(){let e=n.getCurrentPiece();if(e?.grid){for(let t=0;t<4;t++)for(let n=0;n<4;n++)if(e.grid[t]&&e.grid[t][n]){let r=t+e.offset,i=e.height-n;if(i>=0&&i<20&&r>=0&&r<10){let l=e.grid[t][n]-1;l>=0&&l<7&&k(s+r*a,c+(19-i)*o,l)}}}}function k(e,t,n){let r=P?.getPiecesImage(n);r&&N.drawImage(r,e,t,a,o)}function A(e,n,r,i){if(v){N.fillStyle=`#FFFFFF`,N.fillRect(e,n,r,i),N.fillStyle=`#000000`,N.fillRect(e,n,r,t),N.fillRect(e,n,t,i),N.fillRect(e,n+i-t,r,2*t),N.fillRect(e+r-t,n,2*t,i);return}N.fillStyle=`#000000`,N.fillRect(e+2*t,n+2*t,r-t,i-t),N.fillRect(e,n,r,i);let a={topLeft:[`#000000`,`#BBBBBB`,`#FFFFFF`],bottomRight:[`#000000`,`#555555`,`#999999`]};for(let o=0;o<3;o++){let s=o;N.fillStyle=a.topLeft[o],N.fillRect(e+s*t,n+s*t,r-s*2*t,t),N.fillRect(e+s*t,n+s*t,t,i-s*2*t),N.fillStyle=a.bottomRight[o],N.fillRect(e+(s+1)*t,n+i-s*t-t,r-(s*2+1)*t,t),N.fillRect(e+r-s*t-t,n+(s+1)*t,t,i-(s*2+1)*t)}N.fillStyle=a.topLeft[1],N.fillRect(r+e-3*t,n+2*t,t,t),N.fillRect(e+2*t,i+n-3*t,t,t)}function j({isShowingAbout:n}){if(!n)return;let r=P?.getMainSprite(`about`);if(!r?.complete)return;let i=r.naturalWidth,a=r.naturalHeight-(v?2:0),o=i*t,s=a*t,c=o+6*t+6*t,l=s+6*t+6*t;c>e.width&&(c=e.width,l=c*a/i,o=c-6*t-6*t,s=l-6*t-6*t);let u=t*Math.floor((e.width-c)/2/t),d=t*Math.floor((e.height-l)/2/t);A(u,d,c,l);let f=u+3*t+3*t,p=d+3*t+3*t;N.drawImage(r,0,0,i,a,f,p,o,s)}function M({isShowingHighScores:n,lastHighScoreIndex:r,highScores:i}){if(!n)return;let a=452*t,o=308*t;a>e.width&&(a=e.width,o=a*308/452);let s=(e.width-a)/2,c=(e.height-o)/2;A(s,c,a,o),N.fillStyle=`#000000`,N.fillRect(s+3*t,c+3*t,a-6*t,o-6*t);let l=3*t,u=s+l,d=c+l,f=P?.getMainSprite(`highScores`);if(f?.complete){let e=u+109*t+3*t,n=d+3*t;N.drawImage(f,e,n,220*t,50*t)}N.fillStyle=`#FFFFFF`,N.font=`${15*t}px "Times New Roman", serif`;let p=d+62*t,m=22*t,h=u+14*t,g=u+256*t,_=u+320*t,y=u+335*t;N.textAlign=`left`,N.fillText(`Name`,h,p);let{width:b}=N.measureText(`Name`);N.fillRect(h,p+t,b,t),N.textAlign=`right`,N.fillText(`Score`,g,p);let{width:x}=N.measureText(`Score`);N.fillRect(g-x,p+t,x,t),N.fillText(`Rows`,_,p);let{width:S}=N.measureText(`Rows`);N.fillRect(_-S,p+t,S,t),N.textAlign=`left`,N.fillText(`Date`,y,p);let{width:C}=N.measureText(`Date`);N.fillRect(y,p+t,C,t),N.font=`${15*t}px "Times New Roman", serif`;for(let e=0;e<10;e++){let n=i[e],a=p+(e+1)*m+3*t;e===r?v?(N.fillStyle=`#FFFFFF`,N.font=`bold ${16*t}px "Times New Roman", serif`):N.fillStyle=`#FFFF00`:(N.fillStyle=`#FFFFFF`,N.font=`${15*t}px "Times New Roman", serif`),N.textAlign=`left`,N.fillText(`${e+1}. ${n.name}`,h,a),N.textAlign=`right`,N.fillText(String(n.score),g,a),N.fillText(String(n.rows),_,a),N.textAlign=`left`,N.fillText(B(n.date),y,a)}N.textAlign=`left`}let N=z(e),P=null;return y(r),N.fillStyle=`#000000`,N.fillRect(0,0,e.width,e.height),N.fillStyle=`#FFFFFF`,N.font=`${12*t}px Geneva, Helvetica, sans-serif`,N.fillText(`Loading assets...`,20,e.height/2),{drawWindow:x,setSprites:e=>P=e,setLayout:y,setDisplayMode:e=>{v=e===`bw`}}};function z(e){let t=e.getContext(`2d`);if(!t)throw Error(`Could not get context`);return t}function B(e){try{return new Date(e).toLocaleDateString(`en-UK`,{month:`2-digit`,day:`2-digit`,year:`2-digit`})}catch{return`--`}}function V({deadArea:e}){let t=new Map([[e,{}]]),n=new Map,r=new Map,i=(t,n)=>{t!==e&&(n?.(),t.classList.add(`active`))},a=(t,n)=>{t!==e&&(n?.(),t.classList.remove(`active`))},o=(e,n)=>{let r=document.elementFromPoint(e,n);if(!r)return null;for(let[e,n]of t)if(e===r||e.contains(r))return{btn:e,key:n};return null},s=(t,o)=>{let s=n.get(t);if(s?.btn!==o?.btn){if(s){let i=(r.get(s.btn)??0)-1;i<=0?(r.delete(s.btn),a(s.btn,s.key.keyUp)):r.set(s.btn,i),(s.btn!==e||o===void 0)&&n.delete(t)}if(o&&s?.btn!==e){n.set(t,o);let e=(r.get(o.btn)??0)+1;r.set(o.btn,e),e===1&&i(o.btn,o.key.keyDown)}}},c=e=>{for(let t of e.changedTouches)s(t.identifier,o(t.clientX,t.clientY))};document.addEventListener(`touchstart`,c,{passive:!0}),document.addEventListener(`touchmove`,c,{passive:!0});let l=e=>{for(let t of e.changedTouches)s(t.identifier)};return document.addEventListener(`touchend`,l),document.addEventListener(`touchcancel`,l),(e,n)=>{t.set(e,n),e.addEventListener(`pointerdown`,t=>{t.pointerType!==`touch`&&(t.preventDefault(),i(e,n.keyDown))}),e.addEventListener(`pointerup`,t=>{t.pointerType!==`touch`&&a(e,n.keyUp)})}}const H={WINDOW_WIDTH:500,WINDOW_HEIGHT:330,BLOCK_SIZE:16,BOARD_X:170,BOARD_Y:5,NEXT_X:24,NEXT_Y:4,NEXT_SIZE:96,SCORE_X:380,SCORE_Y:4,SCORE_WIDTH:96,SCORE_HEIGHT:60,SCORE_SPACING:20},U={WINDOW_WIDTH:640,WINDOW_HEIGHT:480,BLOCK_SIZE:22,BOARD_X:210,BOARD_Y:25,NEXT_X:18,NEXT_Y:24,NEXT_SIZE:132,SCORE_X:534,SCORE_Y:24,SCORE_WIDTH:96,SCORE_HEIGHT:60,SCORE_SPACING:68},W={WINDOW_WIDTH:445,WINDOW_HEIGHT:462,BLOCK_SIZE:22,BOARD_X:33,BOARD_Y:10,NEXT_X:280,NEXT_Y:10,NEXT_SIZE:132,SCORE_X:297,SCORE_Y:167,SCORE_WIDTH:96,SCORE_HEIGHT:60,SCORE_SPACING:25},ie=[`window`,`fullscreen`,`bw`,`mobile`],G=e=>e===`fullscreen`?U:e===`mobile`?W:H,ae=e=>ie.includes(e);function K(e){return document.getElementById(e)}function q(e){return document.getElementById(e)}function oe(e){return document.getElementById(e)}function J(e){return document.getElementById(e)}function Y(){return document.getElementById(`gameCanvas`)}function se(){navigator?.vibrate?.(10)}const ce=e=>{let t=J(`highScoreModalOverlay`);t.removeAttribute(`hidden`);let n=oe(`highScoreNameInput`);n.value=localStorage.getItem(`tetrisMaxPlayerName`)??`Player`,n.focus(),n.select(),q(`startBtn`).disabled=!0;let r=()=>{let s=n.value&&n.value.trim()?n.value.trim().substring(0,20):`Anonymous`;localStorage.setItem(`tetrisMaxPlayerName`,s),e(s),t.setAttribute(`hidden`,``),q(`startBtn`).disabled=!1,o.removeEventListener(`click`,r),n.removeEventListener(`keydown`,i),t.removeEventListener(`click`,a)},i=e=>{e.key===`Enter`&&r()},a=e=>{e.target===t&&r()},o=q(`highScoreModalOk`);o.addEventListener(`click`,r),n.addEventListener(`keydown`,i),t.addEventListener(`click`,a)},X=e=>{let t=e===`bw`;K(`piecesSelect`).disabled=t,K(`backgroundSelect`).disabled=t,t&&(K(`piecesSelect`).value=`default`,K(`backgroundSelect`).value=`default`),document.body.classList.toggle(`bw`,t)},Z=({isMusicOn:e,isSoundOn:t,piecesStyle:n,backgroundStyle:r,musicStyle:i,displayMode:a,level:o})=>{e!==void 0&&(q(`musicBtn`).textContent=`Music: `+(e?`ON`:`OFF`)),t!==void 0&&(q(`soundBtn`).textContent=`Sound Effects: `+(t?`ON`:`OFF`)),n!==void 0&&(K(`piecesSelect`).value=n),r!==void 0&&(K(`backgroundSelect`).value=r),i!==void 0&&(K(`musicSelect`).value=i),a!==void 0&&(K(`displaySelect`).value=a),o!==void 0&&(K(`levelSelect`).value=o.toString())},le=({onPause:e,onKeyUp:t,onKeyDown:n,onClick:r,onStart:i,onToggleMusic:a,onToggleSound:o,onShowHighScores:s,onShowAbout:c,onSelectLevel:l,onSelectPieces:u,onSelectBackground:p,onSelectMusic:m,onSelectDisplay:h,initialDisplayMode:g,initialSettings:_})=>{X(g),Z(_),document.addEventListener(`keydown`,t=>{if(J(`highScoreModalOverlay`).hasAttribute(`hidden`)){if([`ArrowLeft`,`ArrowRight`,`ArrowDown`,`ArrowUp`,`Space`,`KeyJ`,`KeyL`,`KeyK`,`KeyI`,`KeyM`,`KeyP`].includes(t.code)&&t.preventDefault(),t.code===`KeyP`){e();return}n(t.key)}}),document.addEventListener(`keyup`,e=>{t(e.key)}),Y().addEventListener(`click`,r),q(`startBtn`).addEventListener(`click`,()=>{i(),q(`startBtn`).blur(),document.body.classList.remove(`mobile-controls-expanded`)}),q(`pauseBtn`).addEventListener(`click`,()=>{e(),x===`running`&&document.body.classList.remove(`mobile-controls-expanded`)}),q(`musicBtn`).addEventListener(`click`,()=>{Z({isMusicOn:a()})}),q(`soundBtn`).addEventListener(`click`,()=>{Z({isSoundOn:o()})}),q(`highScoresBtn`).addEventListener(`click`,()=>{s(),document.body.classList.remove(`mobile-controls-expanded`)}),q(`aboutBtn`).addEventListener(`click`,()=>{c(),document.body.classList.remove(`mobile-controls-expanded`)}),K(`levelSelect`).addEventListener(`change`,e=>{let t=e?.target?.value;t&&l(parseInt(t))}),K(`piecesSelect`).addEventListener(`change`,e=>{let t=e?.target?.value;d(t)&&u(t)}),K(`backgroundSelect`).addEventListener(`change`,e=>{let t=e?.target?.value;f(t)&&p(t)}),K(`musicSelect`).addEventListener(`change`,e=>{let t=e?.target?.value;(t===`peter_wagner`||t===`animal_instinct`)&&m(t)}),K(`displaySelect`).addEventListener(`change`,e=>{let t=e?.target?.value;ae(t)&&h(t)});let v=V({deadArea:q(`deadArea`)}),y=e=>({keyDown:()=>{n(e),se()},keyUp:()=>t(e)});v(q(`mobileLeft`),y(`j`)),v(q(`mobileRight`),y(`l`)),v(q(`mobileSoftDrop`),y(`m`)),v(q(`mobileHardDrop`),y(`ArrowDown`));let b=(e,t)=>v(e,{keyUp:()=>t(e)});b(q(`mobileRotateCw`),()=>n(`k`)),b(q(`mobileRotateCcw`),()=>n(`i`)),b(q(`mobileStartPause`),()=>{x===`ready`?i():e()}),b(q(`mobileToggleBar`),()=>{x===`running`&&!document.body.classList.contains(`mobile-controls-expanded`)&&e(),document.body.classList.toggle(`mobile-controls-expanded`)}),document.addEventListener(`touchstart`,e=>{(!(e.target instanceof Element)||!e.target.closest(`.side-panel`))&&(!(e.target instanceof HTMLButtonElement)||e.target.id!==`mobileToggleBar`)&&document.body.classList.remove(`mobile-controls-expanded`)},{capture:!0}),document.body.classList.add(`enable-transition`),J(`mobileControls`).addEventListener(`touchstart`,e=>e.preventDefault());let x=`ready`;return e=>{x=e,q(`startBtn`).textContent=e===`ready`?`Begin Game`:`Abort`,q(`startBtn`).classList.toggle(`primary`,e===`ready`),q(`pauseBtn`).disabled=e===`ready`,q(`pauseBtn`).classList.toggle(`primary`,e===`paused`),q(`pauseBtn`).textContent=e===`paused`?`Resume`:`Pause`,K(`levelSelect`).disabled=e!==`ready`;let t=q(`mobileStartPause`);t.textContent=e===`ready`?`Start`:e===`paused`?`Resume`:`Pause`,J(`sidePanelWrapper`).classList.toggle(`collapsed`,e===`running`),e===`running`?setTimeout(()=>{J(`sidePanelWrapper`).classList.add(`collapsed-interactive`)},300):J(`sidePanelWrapper`).classList.remove(`collapsed-interactive`)}};var Q=`tetrisMaxSettings`,ue=/Android|Mobi|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);const de=()=>{let e=localStorage.getItem(Q),t={};try{t=JSON.parse(e??`{}`)}catch(e){console.error(`Failed to parse settings`,e)}let n={piecesStyle:`default`,backgroundStyle:`default`,musicStyle:`peter_wagner`,displayMode:ue?`mobile`:`window`,level:1,isMusicOn:!0,isSoundOn:!0,...t};return{settings:n,setSetting:(e,t)=>{n[e]=t,localStorage.setItem(Q,JSON.stringify(n))}}};var $=2;async function fe(){let{setSetting:e,settings:t}=de(),r=[],i=-1,a=!1,o=!1,s=!1,c=!1,l=!0,u=0,d=C(),f=()=>{s&&(d.saveState(),g())};document.addEventListener(`visibilitychange`,()=>{document.visibilityState===`hidden`&&f()}),document.addEventListener(`beforeunload`,()=>{f()});let p=R(Y(),$,d,G(t.displayMode),t.displayMode),m=await v(t.backgroundStyle,t.piecesStyle,$,t.displayMode);p.setSprites(m);let h=await n(t.musicStyle,t.isMusicOn,t.isSoundOn);r=re();let g=()=>{c=!0,_(`paused`),h?.stopMusic()},_=le({initialSettings:t,onStart:()=>{if(s){y();return}d.start(t.level),h?.startMusic(t.musicStyle),a=!1,o=!1,u=performance.now(),s=!0,c=!1,l=!1,_(`running`)},onPause:()=>{s&&(c?(c=!1,_(`running`),a=!1,o=!1,h?.startMusic(t.musicStyle),u=performance.now()):(h?.playSound(`pause`),g()))},onKeyUp:e=>{s&&!c&&d.handleKeyUp(e)},onKeyDown:e=>{s&&!c&&d.handleKeyDown(e)},onClick:()=>{a=!1,o=!1},onToggleMusic:()=>(e(`isMusicOn`,h?.toggleMusic(s&&!c)??!1),t.isMusicOn),onToggleSound:()=>(e(`isSoundOn`,h?.toggleSound()??!1),t.isSoundOn),onShowHighScores:()=>{a?a=!1:(o=!1,i=-1,a=!0,s&&!c&&g())},onShowAbout:()=>{o?o=!1:(a=!1,o=!0,s&&!c&&g())},onSelectLevel:t=>{e(`level`,t)},onSelectPieces:n=>{e(`piecesStyle`,n),m.setPiecesImage(t.piecesStyle)},onSelectBackground:n=>{e(`backgroundStyle`,n),m.setBackgroundImages(t.backgroundStyle)},onSelectMusic:n=>{e(`musicStyle`,n);let r=h?.getIsPlaying();r&&h?.stopMusic(),r&&s&&!c&&h?.startMusic(t.musicStyle)},onSelectDisplay:async n=>{e(`displayMode`,n),n===`bw`&&(e(`piecesStyle`,`default`),e(`backgroundStyle`,`default`)),X(n),p.setDisplayMode(n),p.setLayout(G(n)),await m.setDisplayMode(n,t.piecesStyle)},initialDisplayMode:t.displayMode}),y=()=>{c=!1,s=!1,_(`ready`),h?.stopMusic(),I(r,d.getScore())&&(ce(e=>{i=L(r,{name:e,score:d.getScore(),rows:d.getLinesCleared()}),a=!0}),setTimeout(()=>{h?.playSound(`highscore`)},1e3))},b=e=>{if(s&&!c){let t=e-u;u=e,d.tick(t);for(let e of d.getEvents())h?.playSound(e);d.isGameOver()&&(h?.playSound(`gameOver`),y())}p.drawWindow({isShowingHighScores:a,lastHighScoreIndex:i,isShowingWelcomeScreen:l,isShowingAbout:o,isGameInProgress:s,isGamePaused:c,highScores:r}),requestAnimationFrame(b)};d.getCurrentPiece()!==null&&(l=!1,s=!0,g()),requestAnimationFrame(b)}document.addEventListener(`DOMContentLoaded`,fe);