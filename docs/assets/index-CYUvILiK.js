(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e=2,t=10,n=20,r={WINDOW_WIDTH:500,WINDOW_HEIGHT:330,BLOCK_SIZE:16,BOARD_X:170,BOARD_Y:5,NEXT_X:24,NEXT_Y:4,NEXT_SIZE:96,SCORE_X:380,SCORE_Y:4,SCORE_WIDTH:96,SCORE_HEIGHT:60,SCORE_SPACING:20},i=r.BLOCK_SIZE*e,a=r.BLOCK_SIZE*e,o=1e3/60,s={1:30,2:20,3:15,4:12,5:10,6:8,7:7,8:6,9:5,10:4},c={1:10,2:20,3:30,4:40,5:50,6:60,7:70,8:80,9:90,10:32e3},l=100,u=300,d=600,ee=1e3,te=2500,ne=1e4,re=10,ie=1,ae=2,oe=15,f=[],p=[],se=`default`,ce=`default`,le=`peter_wagner`,ue=[`level01.png`,`level02.png`,`level03.png`,`level04.png`,`level05.png`,`level06.png`,`level07.png`,`level08.png`,`level09.png`,`level10.png`];function de(e=null){let t=e||se;return new Promise(e=>{let n=new Image;n.onload=()=>{f=[];for(let e=0;e<7;e++){let t=document.createElement(`canvas`);t.width=i,t.height=a;let r=t.getContext(`2d`);r&&(r.imageSmoothingEnabled=!1,r.drawImage(n,e*16,0,16,16,0,0,i,a),f.push(t))}console.log(`Loaded piece style: ${t}`),e()},n.onerror=()=>{console.warn(`Could not load pieces image, using fallback`),pe(),e()},n.src=`pieces/${t}.png`})}function fe(e=null){let t=e||ce;p=[];let n=ue.map((e,n)=>new Promise(r=>{let i=new Image;i.onload=()=>{p[n]=i,r()},i.onerror=()=>{console.warn(`Could not load background ${e}`),p[n]=null,r()},i.src=`backgrounds/${t}/${e}`}));return Promise.all(n).then(()=>{console.log(`Loaded background style: ${t} (${p.filter(e=>e).length} patterns)`)})}function pe(){let e=[{base:[255,204,0],light:[255,255,102],dark:[153,102,0],highlight:[255,255,204]},{base:[0,204,204],light:[102,255,255],dark:[0,102,102],highlight:[204,255,255]},{base:[255,102,0],light:[255,178,102],dark:[153,51,0],highlight:[255,204,153]},{base:[0,102,255],light:[102,178,255],dark:[0,51,153],highlight:[153,204,255]},{base:[255,0,0],light:[255,102,102],dark:[153,0,0],highlight:[255,153,153]},{base:[0,204,0],light:[102,255,102],dark:[0,102,0],highlight:[153,255,153]},{base:[204,0,204],light:[255,102,255],dark:[102,0,102],highlight:[255,178,255]}];f=[];for(let t=0;t<7;t++){let n=e[t],r=document.createElement(`canvas`);r.width=i,r.height=a;let o=r.getContext(`2d`);o&&(o.fillStyle=`rgb(${n.base[0]}, ${n.base[1]}, ${n.base[2]})`,o.fillRect(0,0,i,a),o.strokeStyle=`#000000`,o.strokeRect(.5,.5,i-1,a-1),o.fillStyle=`rgb(${n.light[0]}, ${n.light[1]}, ${n.light[2]})`,o.fillRect(1,1,i-2,2),o.fillRect(1,1,2,a-2),o.fillStyle=`rgb(${n.dark[0]}, ${n.dark[1]}, ${n.dark[2]})`,o.fillRect(1,a-3,i-2,2),o.fillRect(i-3,1,2,a-2),f.push(r))}}async function me(){await fe()}var m=null,h=null,g=[],_=null,v=null,y=[],b=!1,x=!1,S=0,C=0,he=0,w=1,ge=10,T=[],_e=-1,E=!1,D=null,ve=null,O=!1,k=null,A=0,ye=0,be=0,j=!1,M=!1,N=!1,P=!1,F=!1,xe=!1,Se=!1,I=!1,L=[],Ce=0,we=null,Te=10,R=!1,Ee=0,De=0,Oe=0,z=null,ke={drop:`sounds/drop.wav`,stick:`sounds/stick.wav`,clear1:`sounds/clear1.wav`,clear2:`sounds/clear2.wav`,clear3:`sounds/clear3.wav`,clear4:`sounds/clear4.wav`,highscore:`sounds/highscore.wav`,smallBonus:`sounds/smallBonus.wav`,bigBonus:`sounds/bigBonus.wav`,newLevel:`sounds/newlevel.wav`,gameOver:`sounds/gameover.wav`,pause:`sounds/pause.wav`},Ae={};function je(){y=[];for(let e=0;e<7;e++){let r={height:n+4-3,offset:Math.floor(t/2)-2,color:e,grid:[]};for(let e=0;e<4;e++)r.grid[e]=[0,0,0,0];y.push(r)}y[0].grid[1][1]=1,y[0].grid[1][2]=1,y[0].grid[2][1]=1,y[0].grid[2][2]=1,y[1].grid[1][0]=2,y[1].grid[1][1]=2,y[1].grid[1][2]=2,y[1].grid[1][3]=2,y[2].grid[2][0]=3,y[2].grid[2][1]=3,y[2].grid[2][2]=3,y[2].grid[3][2]=3,y[3].grid[2][0]=4,y[3].grid[2][1]=4,y[3].grid[2][2]=4,y[3].grid[1][2]=4,y[4].grid[2][0]=5,y[4].grid[2][1]=5,y[4].grid[1][1]=5,y[4].grid[1][2]=5,y[5].grid[1][0]=6,y[5].grid[1][1]=6,y[5].grid[2][1]=6,y[5].grid[2][2]=6,y[6].grid[2][2]=7,y[6].grid[1][1]=7,y[6].grid[2][1]=7,y[6].grid[3][1]=7}function Me(e){let t={height:e.height,offset:e.offset,color:e.color,grid:[]};for(let n=0;n<4;n++)t.grid[n]=[...e.grid[n]];return t}function Ne(e,t){let n;switch(e){case 0:return;case 1:n=t[1][0],t[1][0]=t[0][2],t[0][2]=t[2][3],t[2][3]=t[3][1],t[3][1]=n,n=t[2][0],t[2][0]=t[0][1],t[0][1]=t[1][3],t[1][3]=t[3][2],t[3][2]=n,n=t[1][1],t[1][1]=t[1][2],t[1][2]=t[2][2],t[2][2]=t[2][1],t[2][1]=n;break;case 2:case 3:case 4:case 5:case 6:n=t[1][0],t[1][0]=t[1][2],t[1][2]=t[3][2],t[3][2]=t[3][0],t[3][0]=n,n=t[2][0],t[2][0]=t[1][1],t[1][1]=t[2][2],t[2][2]=t[3][1],t[3][1]=n;break}}function Pe(e,t){let n;switch(e){case 0:return;case 1:n=t[3][1],t[3][1]=t[2][3],t[2][3]=t[0][2],t[0][2]=t[1][0],t[1][0]=n,n=t[2][0],t[2][0]=t[3][2],t[3][2]=t[1][3],t[1][3]=t[0][1],t[0][1]=n,n=t[1][1],t[1][1]=t[2][1],t[2][1]=t[2][2],t[2][2]=t[1][2],t[1][2]=n;break;case 2:case 3:case 4:case 5:case 6:n=t[1][0],t[1][0]=t[3][0],t[3][0]=t[3][2],t[3][2]=t[1][2],t[1][2]=n,n=t[2][0],t[2][0]=t[3][1],t[3][1]=t[2][2],t[2][2]=t[1][1],t[1][1]=n;break}}function B(e){let r=e.offset,i=e.height;for(let a=0;a<4;a++)for(let o=0;o<4;o++)if(e.grid[a][o]&&(a+r>=t||a+r<0||i-o<0||i-o<n&&g[a+r][i-o]))return!1;return!0}function Fe(e){let t=!0;for(let r=0;r<4;r++)for(let i=0;i<4;i++)e.grid[r][i]&&(e.height-i<n?g[r+e.offset][e.height-i]=e.grid[r][i]:t=!1);return t}function Ie(e){let r=!1,i=[];$(e?`drop`:`stick`);for(let e=0;e<n;e++){let n=!0,a=0,o=!0;for(let r=0;r<t;r++){if(!g[r][e]){n=!1;break}a===0?a=g[r][e]:g[r][e]!==a&&(o=!1)}n&&(i.push(e),o&&(r=!0))}let a=i.length;a>0?(I=!0,L=i,Ce=Y(),we={dropped:a,bonus:r,wasDropOrFreefall:e},a===1?$(`clear1`):a===2?$(`clear2`):a===3?$(`clear3`):a===4&&$(`clear4`)):(Re(),Be())}function Le(){if(!we)return;let{dropped:e,bonus:r}=we;e===1?S+=l:e===2?S+=u:e===3?S+=d:e===4&&(S+=ee),L.sort((e,t)=>t-e);for(let e of L){for(let r=e;r<n-1;r++)for(let e=0;e<t;e++)g[e][r]=g[e][r+1];for(let e=0;e<t;e++)g[e][n-1]=0}he+=e;let i=!0,a=!1;for(let e=0;e<t&&i;e++)for(let t=0;t<n&&i;t++)g[e][t]&&(i=!1);i&&(a=!0,S+=ne,$(`bigBonus`)),r&&(S+=te,a||$(`smallBonus`)),he>=c[w]&&w<10&&(w++,!r&&!a&&$(`newLevel`)),I=!1,L=[],we=null,Re(),Be()}function Re(){xe=!1,Se=!1,P=!1,j=!1,M=!1,N=!1,F=!1,R=!1}function ze(){if(h){h.fillStyle=`rgb(255, 255, 0)`;for(let e of L){let t=H+(n-1-e)*a;h.fillRect(V,t,U,a)}}}function Be(){return v===null&&(v=Me(y[Math.floor(Math.random()*7)])),_=v,_.height=n+4-3,_.offset=Math.floor(t/2)-2,v=Me(y[Math.floor(Math.random()*7)]),B(_)?(A=Y(),!0):(vt(),!1)}function Ve(){if(!_)return;let e=Y();e-ye>=re&&j&&!N&&(N=!0),e-be>=re&&M&&!N&&(N=!0),e-ye>=ie&&j&&N&&(ye=e,_.offset--,B(_)||_.offset++),e-be>=ie&&M&&N&&(be=e,_.offset++,B(_)||_.offset--);let t=!1,n=s[w];if(P?t=e-A>=ae:F?t=e-A>=oe:(t=e-A>=n,w===10&&_.height%2==0&&(t=e-A>=n-1)),t){if(_.height--,P&&(C+=1),B(_))F=!1;else if(_.height++,F||P){let e=P;F=!1,S+=C,C=0,Fe(_)?Ie(e):vt()}else F=!0;A=e}}var V=r.BOARD_X*e,H=r.BOARD_Y*e,U=t*i,W=n*a,He=r.NEXT_X*e,Ue=r.NEXT_Y*e,We=r.NEXT_SIZE*e,Ge=r.SCORE_X*e,Ke=r.SCORE_Y*e,qe=r.SCORE_WIDTH*e,Je=r.SCORE_HEIGHT*e,Ye=r.SCORE_SPACING*e;function G(){let t=p[w-1];if(t&&t.complete&&t.naturalWidth>0){let n=document.createElement(`canvas`);n.width=t.width*e,n.height=t.height*e;let r=n.getContext(`2d`);if(!r||(r.imageSmoothingEnabled=!1,r.drawImage(t,0,0,n.width,n.height),!h))return;let i=h.createPattern(n,`repeat`);i&&(h.fillStyle=i),m&&h.fillRect(0,0,m.width,m.height)}Xe(),Ze(),Qe(),E&&At(),O&&kt()}function Xe(){if(h&&(h.fillStyle=`#000000`,h.fillRect(He,Ue,We,We),h.strokeStyle=`#FFFFFF`,h.lineWidth=e,h.strokeRect(He+1,Ue+1,We-2,We-2),h.fillStyle=`#FFFF00`,h.font=`${9*e}px Geneva, Helvetica, sans-serif`,h.fillText(`Next:`,He+3*e,Ue+12*e),v&&v.grid)){let e=0,t=0;switch(v.color){case 1:e=i/2;break;case 2:e=-i,t=i/2;break;case 6:e=-i/2;break;case 3:case 4:case 5:t=i/2;break}let n=He+i+e,r=Ue+a+t;for(let e=0;e<4;e++)for(let t=0;t<4;t++)if(v.grid[e]&&v.grid[e][t]){let o=n+e*i,s=r+t*a,c=v.color;c>=0&&c<7&&f[c]&&h.drawImage(f[c],o,s,i,a)}}}function Ze(){if(tt){ot();return}h&&(h.fillStyle=`#000000`,h.fillRect(V,H,U,W),ct(),_&&b&&!I&&lt(),I&&L.length>0&&ze(),h.strokeStyle=`#FFFFFF`,h.lineWidth=e,h.strokeRect(V-1,H-1,U+2,W+2),x?st(`pause`):!b&&_&&st(`gameover`))}function Qe(){if(!h)return;let t=[nt,rt,it],n=[S,w,he],r=98*e,i=63*e;for(let a=0;a<3;a++){let o=Ke+a*(Je+Ye),s=t[a];s&&s.complete&&s.naturalWidth>0?h.drawImage(s,Ge,o,r,i):(h.fillStyle=`#000000`,h.fillRect(Ge,o,qe,Je),h.strokeStyle=`#FFFFFF`,h.lineWidth=e,h.strokeRect(Ge+e*.5,o+e*.5,qe-e,Je-e)),h.fillStyle=`#4E4E4E`,h.font=`${18*e}px Georgia, "Times New Roman", serif`,h.textAlign=`right`,h.fillText(String(n[a]),Ge+89*e,o+50*e)}h.textAlign=`left`}var $e=null,et=null,K=null,tt=!0,nt=null,rt=null,it=null;async function at(){return new Promise(e=>{let t=0,n=()=>{t++,t>=8&&e()};$e=new Image,$e.onload=n,$e.onerror=n,$e.src=`sprites/gameover.png`,et=new Image,et.onload=n,et.onerror=n,et.src=`sprites/pause.png`,K=new Image,K.onload=n,K.onerror=n,K.src=`sprites/welcome.png`,D=new Image,D.onload=n,D.onerror=n,D.src=`sprites/highscores.png`,k=new Image,k.onload=n,k.onerror=n,k.src=`sprites/about.png`,nt=new Image,nt.onload=n,nt.onerror=n,nt.src=`sprites/score_frame.png`,rt=new Image,rt.onload=n,rt.onerror=n,rt.src=`sprites/level_frame.png`,it=new Image,it.onload=n,it.onerror=n,it.src=`sprites/rows_frame.png`})}function ot(){h&&(K&&K.complete&&K.naturalWidth>0?h.drawImage(K,V,H,U,W):(h.fillStyle=`#000000`,h.fillRect(V,H,U,W)),h.strokeStyle=`#FFFFFF`,h.lineWidth=e,h.strokeRect(V-1,H-1,U+2,W+2))}function st(t){if(!h)return;let n=V,r=H+7*a,i=U,o=5*a,s=t===`pause`?et:$e;s&&s.complete&&s.naturalWidth>0?h.drawImage(s,n,r,i,o):(h.fillStyle=`#000066`,h.fillRect(n,r,i,o),h.fillStyle=`#FFFFFF`,h.font=`bold ${16*e}px Geneva, Helvetica, sans-serif`,h.textAlign=`center`,h.textBaseline=`middle`,h.fillText(t===`pause`?`PAUSED`:`GAME OVER`,n+i/2,r+o/2),h.textAlign=`left`,h.textBaseline=`alphabetic`)}function ct(){if(g){for(let e=0;e<t;e++)if(g[e]){for(let t=0;t<n;t++)if(g[e][t]){let r=g[e][t]-1;r>=0&&r<7&&ut(V+e*i,H+(n-1-t)*a,r)}}}}function lt(){if(!(!_||!_.grid)){for(let e=0;e<4;e++)for(let r=0;r<4;r++)if(_.grid[e]&&_.grid[e][r]){let o=e+_.offset,s=_.height-r;if(s>=0&&s<n&&o>=0&&o<t){let t=_.grid[e][r]-1;t>=0&&t<7&&ut(V+o*i,H+(n-1-s)*a,t)}}}}function ut(e,t,n){h&&f[n]&&h.drawImage(f[n],e,t,i,a)}function dt(e){!b||x||(e=e.toLowerCase(),!(R||I)&&(_&&(e===`k`&&(Pe(_.color,_.grid),B(_)||Ne(_.color,_.grid)),(e===`i`||e===`arrowup`)&&(Ne(_.color,_.grid),B(_)||Pe(_.color,_.grid)),e===`m`&&!Se&&(P=!0,Se=!0,M=!1,j=!1,N=!1),(e===`j`||e===`arrowleft`)&&(M=!1,j||(j=!0,ye=Y(),_.offset--,B(_)||_.offset++)),(e===`l`||e===`arrowright`)&&(j=!1,M||(M=!0,be=Y(),_.offset++,B(_)||_.offset--))),(e===` `||e===`arrowdown`)&&!xe&&!R&&(M=!1,j=!1,xe=!0,F=!1,R=!0,Ee=Y())))}function ft(){if(!R||!_)return;let e=Y();e-Ee>=1&&(Ee=e,_.height--,C+=1,B(_)||(--C,_.height++,R=!1,S+=C,C=0,Fe(_)?Ie(!0):vt(),A=Y()))}function pt(e){e=e.toLowerCase(),(e===`j`||e===`arrowleft`)&&(j=!1,N=!1),(e===`l`||e===`arrowright`)&&(M=!1,N=!1),e===`m`&&(P=!1,Se=!1),(e===` `||e===`arrowdown`)&&(xe=!1)}function mt(){g=[];for(let e=0;e<t;e++){g[e]=[];for(let t=0;t<n;t++)g[e][t]=0}je(),S=0,C=0,he=0,_=null,v=null,j=!1,M=!1,N=!1,P=!1,F=!1,xe=!1,Se=!1,R=!1}function q(e){return document.getElementById(e)}function J(e){return document.getElementById(e)}function ht(e){return document.getElementById(e)}function gt(e){return document.getElementById(e)}function _t(){let e=q(`levelSelect`);w=parseInt(e.value),mt(),b=!0,x=!1,tt=!1,v=Me(y[Math.floor(Math.random()*7)]),Be(),J(`startBtn`).textContent=`Restart`,J(`pauseBtn`).disabled=!1,J(`pauseBtn`).textContent=`Pause`,q(`levelSelect`).disabled=!0,A=Y(),De=performance.now(),Oe=0,Q&&Wt()}function vt(){b=!1,Kt(),$(`gameOver`),J(`startBtn`).textContent=`Begin Game`,J(`pauseBtn`).disabled=!0,q(`levelSelect`).disabled=!1,setTimeout(()=>{xt()},1e3)}function yt(){try{let e=localStorage.getItem(`tetrisMaxHighScores`);if(e)T=JSON.parse(e);else{T=[];for(let e=0;e<ge;e++)T.push({name:`Anonymous`,score:0,rows:0,date:new Date(`1970-01-01`).toISOString()})}}catch(e){console.log(`Failed to load high scores:`,e),T=[]}}function bt(){try{localStorage.setItem(`tetrisMaxHighScores`,JSON.stringify(T))}catch(e){console.log(`Failed to save high scores:`,e)}}async function xt(){if(S!==0){_e=-1;for(let e=0;e<ge;e++)if(S>=T[e].score){_e=e;let t=e,n=S,r=he;z&&z.state===`suspended`&&await z.resume(),$(`highscore`),Tt(t,n,r);return}}}function St(e){try{return new Date(e).toLocaleDateString(`en-US`,{month:`numeric`,day:`numeric`,year:`2-digit`})}catch{return`--`}}function Ct(){if(E=!0,b&&!x&&(x=!0,J(`pauseBtn`).textContent=`Resume`,Z)){try{Z.onended=null,Z.stop()}catch{}Z=null}G()}function wt(){E=!1,G()}function Tt(e,t,n){ve={scoreIndex:e,finalScore:t,finalRows:n};let r=document.getElementById(`highScoreModalOverlay`),i=ht(`highScoreNameInput`),a=J(`startBtn`);document.documentElement.style.setProperty(`--highscore-piece-url`,`url('pieces/${se}.png')`),r&&r.removeAttribute(`hidden`),i&&(i.value=`Player`,i.focus(),i.select()),a&&(a.disabled=!0)}function Et(){if(!ve)return;let{scoreIndex:e,finalScore:t,finalRows:n}=ve;ve=null;let r=ht(`highScoreNameInput`),i={name:r&&r.value&&r.value.trim()?r.value.trim().substring(0,20):`Anonymous`,score:t,rows:n,date:new Date().toISOString()};for(let t=ge-1;t>e;t--)T[t]=T[t-1];T[e]=i,bt();let a=gt(`highScoreModalOverlay`),o=J(`startBtn`);a&&a.setAttribute(`hidden`,``),o&&(o.disabled=!1),Ct()}function Dt(){if(O=!0,b&&!x&&(x=!0,J(`pauseBtn`).textContent=`Resume`,Z)){try{Z.onended=null,Z.stop()}catch{}Z=null}G()}function Ot(){O=!1,G()}function kt(){if(!O||!m||!h)return;let t=k&&k.complete&&k.naturalWidth>0?k.naturalWidth:700,n=k&&k.complete&&k.naturalHeight>0?k.naturalHeight:410,r=t*e,i=n*e,a=m.width-0-6,o=m.height-0-6;if(r>a||i>o){let e=Math.min(a/r,o/i);r*=e,i*=e}let s=.75;r*=s,i*=s;let c=r+0+6,l=i+0+6,u=(m.width-c)/2,d=(m.height-l)/2;h.fillStyle=`#000000`,h.fillRect(u+e,d+e,c,l),h.fillStyle=`#000000`,h.fillRect(u,d,c,l);let ee={topLeft:[`#000000`,`#BBBBBB`,`#FFFFFF`],bottomRight:[`#000000`,`#555555`,`#999999`]};for(let e=0;e<3;e++){let t=e;h.fillStyle=ee.topLeft[e],h.fillRect(u+t,d+t,c-t*2,1),h.fillRect(u+t,d+t,1,l-t*2),h.fillStyle=ee.bottomRight[e],h.fillRect(u+t,d+l-t-1,c-t*2,1),h.fillRect(u+c-t-1,d+t,1,l-t*2)}h.fillStyle=`#000000`,h.fillRect(u+3,d+3,c-6,l-6);let te=u+3+0,ne=d+3+0;k&&k.complete&&k.naturalWidth>0&&h.drawImage(k,te,ne,r,i)}function At(){if(!E||!m||!h)return;let t=440*e,n=296*e,r=(m.width-t)/2,i=(m.height-n)/2;h.fillStyle=`#000000`,h.fillRect(r+e,i+e,t,n),h.fillStyle=`#000000`,h.fillRect(r,i,t,n);let a={topLeft:[`#000000`,`#BBBBBB`,`#FFFFFF`],bottomRight:[`#000000`,`#555555`,`#999999`]};for(let e=0;e<3;e++){let o=e;h.fillStyle=a.topLeft[e],h.fillRect(r+o,i+o,t-o*2,1),h.fillRect(r+o,i+o,1,n-o*2),h.fillStyle=a.bottomRight[e],h.fillRect(r+o,i+n-o-1,t-o*2,1),h.fillRect(r+t-o-1,i+o,1,n-o*2)}h.fillStyle=`#000000`,h.fillRect(r+3*e,i+3*e,t-6*e,n-6*e);let o=3*e,s=r+o,c=i+o;if(D&&D.complete&&D.naturalWidth>0){let t=s+109*e,n=c;h.drawImage(D,t,n,220*e,50*e)}h.fillStyle=`#FFFFFF`,h.font=`italic ${14*e}px Georgia, "Times New Roman", serif`;let l=c+60*e,u=22*e,d=s+10*e,ee=s+255*e,te=s+320*e,ne=s+335*e;h.textAlign=`left`,h.fillText(`Name`,d,l),h.textAlign=`right`,h.fillText(`Score`,ee,l),h.fillText(`Rows`,te,l),h.textAlign=`left`,h.fillText(`Date`,ne,l),h.font=`${14*e}px Georgia, "Times New Roman", serif`;for(let t=0;t<ge;t++){let n=T[t],r=l+(t+1)*u+5*e;t===_e?h.fillStyle=`#FFFF00`:h.fillStyle=`#FFFFFF`,h.textAlign=`left`,h.fillText(`${t+1}. ${n.name}`,d,r),h.textAlign=`right`,h.fillText(String(n.score),ee,r),h.fillText(String(n.rows),te,r),h.textAlign=`left`,h.fillText(St(n.date),ne,r)}h.textAlign=`left`}function jt(){if(b){if(x=!x,J(`pauseBtn`).textContent=x?`Resume`:`Pause`,x){if($(`pause`),Z){try{Z.onended=null,Z.stop()}catch{}Z=null}}else A=Y(),E&&=!1,O&&=!1,Q&&Pt.length>0&&Wt();G()}}var Mt=0;function Y(){return Mt}function Nt(e){let t=e-De;for(De=e,Oe+=t;Oe>=o;)Mt++,Oe-=o,b&&!x&&(I?Y()-Ce>=Te&&Le():R?ft():Ve());G(),requestAnimationFrame(Nt)}var Pt=[],Ft=[],X=0,It=0,Lt=0,Z=null,Rt=null,Q=!0,zt=!0,Bt={peter_wagner:{prefix:`peter_wagner`,segments:[`repeat`,`repeat`,`CD`,`repeat`,`repeat`,`E`,`E`,`Fa`,`Fb`,`Fc`,`repeat`,`repeat`,`E`,`Fb`,`G`],repeatSegment:0,folder:`music`},animal_instinct:{prefix:`animal_instinct`,segments:[`A`],repeatSegment:0,folder:`music`}},Vt=!1;async function Ht(){try{z=new window.AudioContext({latencyHint:`interactive`});let e=Object.keys(ke);for(let t of e)try{let e=ke[t],n=await(await fetch(e)).arrayBuffer();Ae[t]=await z.decodeAudioData(n)}catch(e){console.log(`Failed to load sound: ${t}`,e)}console.log(`Loaded ${Object.keys(Ae).length} sounds`),await Ut(le)}catch(e){console.log(`Audio not available:`,e)}}async function Ut(e){let t=Bt[e];if(!t){console.warn(`Unknown music style: ${e}`);return}if(!z)return;Ft=t.segments,It=t.repeatSegment,Lt=t.segments.length-1;let n=[...new Set(Ft)],r={};for(let e of n)try{let n=await(await fetch(`${t.folder}/${t.prefix}_${e}.wav`)).arrayBuffer();r[e]=await z.decodeAudioData(n)}catch(t){console.log(`Failed to load music segment: ${e}`,t),r[e]=null}Pt=Ft.map(e=>r[e]||null),console.log(`Loaded music style: ${e} (${Object.keys(r).filter(e=>r[e]).length} segments)`)}function Wt(){!z||!Q||Pt.length===0||(z.state===`suspended`&&z.resume(),X=0,Vt=!0,Gt())}function Gt(){if(!Vt||!Q||x||!z)return;(X>=Pt.length||X<0)&&(X=It);let e=Pt[X];if(!e){X===Lt?X=It:X++,Gt();return}if(Z)try{Z.onended=null,Z.stop()}catch{}Z=z.createBufferSource(),Z.buffer=e,Rt=z.createGain(),Rt.gain.value=.3,Z.connect(Rt),Rt.connect(z.destination),Z.onended=()=>{Vt&&Q&&(X===Lt?X=It:X++,Gt())},Z.start(0)}function Kt(){if(Vt=!1,Z){try{Z.onended=null,Z.stop()}catch{}Z=null}}function qt(){Q=!Q,Q&&b&&!x?Wt():Kt();let e=document.getElementById(`musicBtn`);e&&(e.textContent=Q?`Music: ON`:`Music: OFF`)}function Jt(){zt=!zt;let e=document.getElementById(`soundBtn`);e&&(e.textContent=zt?`Sound Effects: ON`:`Sound Effects: OFF`)}function $(e){if(!z||!Ae[e]||!zt)return;z.state===`suspended`&&z.resume();let t=z.createBufferSource();t.buffer=Ae[e];let n=z.createGain();n.gain.value=.5,t.connect(n),n.connect(z.destination),t.start(z.currentTime+.01)}async function Yt(){if(m=document.getElementById(`gameCanvas`),h=m.getContext(`2d`),!h){console.error(`Could not get context`);return}m.width=r.WINDOW_WIDTH*e,m.height=r.WINDOW_HEIGHT*e,h.imageSmoothingEnabled=!1,h.fillStyle=`#000000`,h.fillRect(0,0,m.width,m.height),h.fillStyle=`#FFFFFF`,h.font=`${12*e}px Geneva, Helvetica, sans-serif`,h.fillText(`Loading assets...`,20,m.height/2),await de(),await me(),await at(),await Ht(),mt(),yt(),document.addEventListener(`keydown`,e=>{if([`ArrowLeft`,`ArrowRight`,`ArrowDown`,`ArrowUp`,`Space`,`KeyJ`,`KeyL`,`KeyK`,`KeyI`,`KeyM`,`KeyP`].includes(e.code)&&e.preventDefault(),e.code===`KeyP`){jt();return}dt(e.key)}),document.addEventListener(`keyup`,e=>{pt(e.key)}),m.addEventListener(`click`,()=>{E&&wt(),O&&Ot()}),J(`startBtn`).addEventListener(`click`,()=>{z&&z.state===`suspended`&&z.resume(),E&&wt(),O&&Ot(),_t()}),J(`pauseBtn`).addEventListener(`click`,jt),J(`musicBtn`).addEventListener(`click`,qt),J(`soundBtn`).addEventListener(`click`,Jt),J(`highScoresBtn`).addEventListener(`click`,()=>{E?wt():(Ot(),_e=-1,Ct())}),J(`aboutBtn`).addEventListener(`click`,()=>{O?Ot():(wt(),Dt())});let t=document.getElementById(`highScoreModalOverlay`),n=document.getElementById(`highScoreNameInput`),i=document.getElementById(`highScoreModalOk`);i&&i.addEventListener(`click`,Et),n&&n.addEventListener(`keydown`,e=>{e.key===`Enter`&&Et()}),t&&t.addEventListener(`click`,e=>{e.target===t&&Et()}),q(`piecesSelect`).addEventListener(`change`,async e=>{se=e?.target?.value,await de(se),G()}),q(`backgroundSelect`).addEventListener(`change`,async e=>{ce=e?.target?.value,await fe(ce),G()}),q(`musicSelect`).addEventListener(`change`,async e=>{let t=Vt;t&&Kt();let n=e?.target?.value;(n===`peter_wagner`||n===`animal_instinct`)&&(le=n),await Ut(le),t&&b&&!x&&Wt()}),G(),De=performance.now(),requestAnimationFrame(Nt)}document.addEventListener(`DOMContentLoaded`,Yt);