(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e=2,t=10,n=20,r={WINDOW_WIDTH:500,WINDOW_HEIGHT:330,BLOCK_SIZE:16,BOARD_X:170,BOARD_Y:5,NEXT_X:24,NEXT_Y:4,NEXT_SIZE:96,SCORE_X:380,SCORE_Y:4,SCORE_WIDTH:96,SCORE_HEIGHT:60,SCORE_SPACING:20},i=r.BLOCK_SIZE*e,a=r.BLOCK_SIZE*e,o=1e3/60,s={1:30,2:20,3:15,4:12,5:10,6:8,7:7,8:6,9:5,10:4},c={1:10,2:20,3:30,4:40,5:50,6:60,7:70,8:80,9:90,10:32e3},l=100,ee=300,te=600,ne=1e3,re=2500,ie=1e4,ae=10,oe=1,se=2,ce=15,u=[],d=[],le=`default`,ue=`default`,de=`peter_wagner`,fe=[`level01.png`,`level02.png`,`level03.png`,`level04.png`,`level05.png`,`level06.png`,`level07.png`,`level08.png`,`level09.png`,`level10.png`];function pe(e=null){let t=e||le;return new Promise(e=>{let n=new Image;n.onload=()=>{u=[];for(let e=0;e<7;e++){let t=document.createElement(`canvas`);t.width=i,t.height=a;let r=t.getContext(`2d`);r&&(r.imageSmoothingEnabled=!1,r.drawImage(n,e*16,0,16,16,0,0,i,a),u.push(t))}console.log(`Loaded piece style: ${t}`),e()},n.onerror=()=>{console.warn(`Could not load pieces image, using fallback`),he(),e()},n.src=`pieces/${t}.png`})}function me(e=null){let t=e||ue;d=[];let n=fe.map((e,n)=>new Promise(r=>{let i=new Image;i.onload=()=>{d[n]=i,r()},i.onerror=()=>{console.warn(`Could not load background ${e}`),d[n]=null,r()},i.src=`backgrounds/${t}/${e}`}));return Promise.all(n).then(()=>{console.log(`Loaded background style: ${t} (${d.filter(e=>e).length} patterns)`)})}function he(){let e=[{base:[255,204,0],light:[255,255,102],dark:[153,102,0],highlight:[255,255,204]},{base:[0,204,204],light:[102,255,255],dark:[0,102,102],highlight:[204,255,255]},{base:[255,102,0],light:[255,178,102],dark:[153,51,0],highlight:[255,204,153]},{base:[0,102,255],light:[102,178,255],dark:[0,51,153],highlight:[153,204,255]},{base:[255,0,0],light:[255,102,102],dark:[153,0,0],highlight:[255,153,153]},{base:[0,204,0],light:[102,255,102],dark:[0,102,0],highlight:[153,255,153]},{base:[204,0,204],light:[255,102,255],dark:[102,0,102],highlight:[255,178,255]}];u=[];for(let t=0;t<7;t++){let n=e[t],r=document.createElement(`canvas`);r.width=i,r.height=a;let o=r.getContext(`2d`);o&&(o.fillStyle=`rgb(${n.base[0]}, ${n.base[1]}, ${n.base[2]})`,o.fillRect(0,0,i,a),o.strokeStyle=`#000000`,o.strokeRect(.5,.5,i-1,a-1),o.fillStyle=`rgb(${n.light[0]}, ${n.light[1]}, ${n.light[2]})`,o.fillRect(1,1,i-2,2),o.fillRect(1,1,2,a-2),o.fillStyle=`rgb(${n.dark[0]}, ${n.dark[1]}, ${n.dark[2]})`,o.fillRect(1,a-3,i-2,2),o.fillRect(i-3,1,2,a-2),u.push(r))}}async function ge(){await me()}var f=null,p=null,m=[],h=null,g=null,_=[],v=!1,y=!1,b=0,x=0,S=0,C=1,_e=10,w=[],ve=-1,T=!1,E=null,ye=null,D=!1,O=null,k=0,be=0,xe=0,A=!1,j=!1,M=!1,N=!1,P=!1,F=!1,Se=!1,I=!1,L=[],Ce=0,we=null,Te=10,R=!1,Ee=0,De=0,Oe=0,z=null,ke={drop:`sounds/drop.wav`,stick:`sounds/stick.wav`,clear1:`sounds/clear1.wav`,clear2:`sounds/clear2.wav`,clear3:`sounds/clear3.wav`,clear4:`sounds/clear4.wav`,highscore:`sounds/highscore.wav`,smallBonus:`sounds/smallBonus.wav`,bigBonus:`sounds/bigBonus.wav`,newLevel:`sounds/newlevel.wav`,gameOver:`sounds/gameover.wav`,pause:`sounds/pause.wav`},Ae={};function je(){_=[];for(let e=0;e<7;e++){let r={height:n+4-3,offset:Math.floor(t/2)-2,color:e,grid:[]};for(let e=0;e<4;e++)r.grid[e]=[0,0,0,0];_.push(r)}_[0].grid[1][1]=1,_[0].grid[1][2]=1,_[0].grid[2][1]=1,_[0].grid[2][2]=1,_[1].grid[1][0]=2,_[1].grid[1][1]=2,_[1].grid[1][2]=2,_[1].grid[1][3]=2,_[2].grid[2][0]=3,_[2].grid[2][1]=3,_[2].grid[2][2]=3,_[2].grid[3][2]=3,_[3].grid[2][0]=4,_[3].grid[2][1]=4,_[3].grid[2][2]=4,_[3].grid[1][2]=4,_[4].grid[2][0]=5,_[4].grid[2][1]=5,_[4].grid[1][1]=5,_[4].grid[1][2]=5,_[5].grid[1][0]=6,_[5].grid[1][1]=6,_[5].grid[2][1]=6,_[5].grid[2][2]=6,_[6].grid[2][2]=7,_[6].grid[1][1]=7,_[6].grid[2][1]=7,_[6].grid[3][1]=7}function Me(e){let t={height:e.height,offset:e.offset,color:e.color,grid:[]};for(let n=0;n<4;n++)t.grid[n]=[...e.grid[n]];return t}function Ne(e,t){let n;switch(e){case 0:return;case 1:n=t[1][0],t[1][0]=t[0][2],t[0][2]=t[2][3],t[2][3]=t[3][1],t[3][1]=n,n=t[2][0],t[2][0]=t[0][1],t[0][1]=t[1][3],t[1][3]=t[3][2],t[3][2]=n,n=t[1][1],t[1][1]=t[1][2],t[1][2]=t[2][2],t[2][2]=t[2][1],t[2][1]=n;break;case 2:case 3:case 4:case 5:case 6:n=t[1][0],t[1][0]=t[1][2],t[1][2]=t[3][2],t[3][2]=t[3][0],t[3][0]=n,n=t[2][0],t[2][0]=t[1][1],t[1][1]=t[2][2],t[2][2]=t[3][1],t[3][1]=n;break}}function Pe(e,t){let n;switch(e){case 0:return;case 1:n=t[3][1],t[3][1]=t[2][3],t[2][3]=t[0][2],t[0][2]=t[1][0],t[1][0]=n,n=t[2][0],t[2][0]=t[3][2],t[3][2]=t[1][3],t[1][3]=t[0][1],t[0][1]=n,n=t[1][1],t[1][1]=t[2][1],t[2][1]=t[2][2],t[2][2]=t[1][2],t[1][2]=n;break;case 2:case 3:case 4:case 5:case 6:n=t[1][0],t[1][0]=t[3][0],t[3][0]=t[3][2],t[3][2]=t[1][2],t[1][2]=n,n=t[2][0],t[2][0]=t[3][1],t[3][1]=t[2][2],t[2][2]=t[1][1],t[1][1]=n;break}}function B(e){let r=e.offset,i=e.height;for(let a=0;a<4;a++)for(let o=0;o<4;o++)if(e.grid[a][o]&&(a+r>=t||a+r<0||i-o<0||i-o<n&&m[a+r][i-o]))return!1;return!0}function Fe(e){let t=!0;for(let r=0;r<4;r++)for(let i=0;i<4;i++)e.grid[r][i]&&(e.height-i<n?m[r+e.offset][e.height-i]=e.grid[r][i]:t=!1);return t}function Ie(e){let r=!1,i=[];$(e?`drop`:`stick`);for(let e=0;e<n;e++){let n=!0,a=0,o=!0;for(let r=0;r<t;r++){if(!m[r][e]){n=!1;break}a===0?a=m[r][e]:m[r][e]!==a&&(o=!1)}n&&(i.push(e),o&&(r=!0))}let a=i.length;a>0?(I=!0,L=i,Ce=Y(),we={dropped:a,bonus:r,wasDropOrFreefall:e},a===1?$(`clear1`):a===2?$(`clear2`):a===3?$(`clear3`):a===4&&$(`clear4`)):(Re(),Be())}function Le(){if(!we)return;let{dropped:e,bonus:r}=we;e===1?b+=l:e===2?b+=ee:e===3?b+=te:e===4&&(b+=ne),L.sort((e,t)=>t-e);for(let e of L){for(let r=e;r<n-1;r++)for(let e=0;e<t;e++)m[e][r]=m[e][r+1];for(let e=0;e<t;e++)m[e][n-1]=0}S+=e;let i=!0,a=!1;for(let e=0;e<t&&i;e++)for(let t=0;t<n&&i;t++)m[e][t]&&(i=!1);i&&(a=!0,b+=ie,$(`bigBonus`)),r&&(b+=re,a||$(`smallBonus`)),S>=c[C]&&C<10&&(C++,!r&&!a&&$(`newLevel`)),I=!1,L=[],we=null,Re(),Be()}function Re(){F=!1,Se=!1,N=!1,A=!1,j=!1,M=!1,P=!1,R=!1}function ze(){if(p){p.fillStyle=`rgb(255, 255, 0)`;for(let e of L){let t=H+(n-1-e)*a;p.fillRect(V,t,U,a)}}}function Be(){return g===null&&(g=Me(_[Math.floor(Math.random()*7)])),h=g,h.height=n+4-3,h.offset=Math.floor(t/2)-2,g=Me(_[Math.floor(Math.random()*7)]),B(h)?(k=Y(),!0):(vt(),!1)}function Ve(){if(!h)return;let e=Y();e-be>=ae&&A&&!M&&(M=!0),e-xe>=ae&&j&&!M&&(M=!0),e-be>=oe&&A&&M&&(be=e,h.offset--,B(h)||h.offset++),e-xe>=oe&&j&&M&&(xe=e,h.offset++,B(h)||h.offset--);let t=!1,n=s[C];if(N?t=e-k>=se:P?t=e-k>=ce:(t=e-k>=n,C===10&&h.height%2==0&&(t=e-k>=n-1)),t){if(h.height--,N&&(x+=1),B(h))P=!1;else if(h.height++,P||N){let e=N;P=!1,b+=x,x=0,Fe(h)?Ie(e):vt()}else P=!0;k=e}}var V=r.BOARD_X*e,H=r.BOARD_Y*e,U=t*i,W=n*a,He=r.NEXT_X*e,Ue=r.NEXT_Y*e,We=r.NEXT_SIZE*e,Ge=r.SCORE_X*e,Ke=r.SCORE_Y*e,qe=r.SCORE_WIDTH*e,Je=r.SCORE_HEIGHT*e,Ye=r.SCORE_SPACING*e;function G(){let t=d[C-1];if(t&&t.complete&&t.naturalWidth>0){let n=document.createElement(`canvas`);n.width=t.width*e,n.height=t.height*e;let r=n.getContext(`2d`);if(!r||(r.imageSmoothingEnabled=!1,r.drawImage(t,0,0,n.width,n.height),!p))return;let i=p.createPattern(n,`repeat`);i&&(p.fillStyle=i),f&&p.fillRect(0,0,f.width,f.height)}Xe(),Ze(),Qe(),T&&At(),D&&kt()}function Xe(){if(p&&(p.fillStyle=`#000000`,p.fillRect(He,Ue,We,We),p.strokeStyle=`#FFFFFF`,p.lineWidth=e,p.strokeRect(He+1,Ue+1,We-2,We-2),p.fillStyle=`#FFFF00`,p.font=`${9*e}px Geneva, Helvetica, sans-serif`,p.fillText(`Next:`,He+3*e,Ue+12*e),g&&g.grid)){let e=0,t=0;switch(g.color){case 1:e=i/2;break;case 2:e=-i,t=i/2;break;case 6:e=-i/2;break;case 3:case 4:case 5:t=i/2;break}let n=He+i+e,r=Ue+a+t;for(let e=0;e<4;e++)for(let t=0;t<4;t++)if(g.grid[e]&&g.grid[e][t]){let o=n+e*i,s=r+t*a,c=g.color;c>=0&&c<7&&u[c]&&p.drawImage(u[c],o,s,i,a)}}}function Ze(){if(tt){ot();return}p&&(p.fillStyle=`#000000`,p.fillRect(V,H,U,W),ct(),h&&v&&!I&&lt(),I&&L.length>0&&ze(),p.strokeStyle=`#FFFFFF`,p.lineWidth=e,p.strokeRect(V-1,H-1,U+2,W+2),y?st(`pause`):!v&&h&&st(`gameover`))}function Qe(){if(!p)return;let t=[nt,rt,it],n=[b,C,S],r=98*e,i=63*e;for(let a=0;a<3;a++){let o=Ke+a*(Je+Ye),s=t[a];s&&s.complete&&s.naturalWidth>0?p.drawImage(s,Ge,o,r,i):(p.fillStyle=`#000000`,p.fillRect(Ge,o,qe,Je),p.strokeStyle=`#FFFFFF`,p.lineWidth=e,p.strokeRect(Ge+e*.5,o+e*.5,qe-e,Je-e)),p.fillStyle=`#4E4E4E`,p.font=`${18*e}px Georgia, "Times New Roman", serif`,p.textAlign=`right`,p.fillText(String(n[a]),Ge+89*e,o+50*e)}p.textAlign=`left`}var $e=null,et=null,K=null,tt=!0,nt=null,rt=null,it=null;async function at(){return new Promise(e=>{let t=0,n=()=>{t++,t>=8&&e()};$e=new Image,$e.onload=n,$e.onerror=n,$e.src=`sprites/gameover.png`,et=new Image,et.onload=n,et.onerror=n,et.src=`sprites/pause.png`,K=new Image,K.onload=n,K.onerror=n,K.src=`sprites/welcome.png`,E=new Image,E.onload=n,E.onerror=n,E.src=`sprites/highscores.png`,O=new Image,O.onload=n,O.onerror=n,O.src=`sprites/about.png`,nt=new Image,nt.onload=n,nt.onerror=n,nt.src=`sprites/score_frame.png`,rt=new Image,rt.onload=n,rt.onerror=n,rt.src=`sprites/level_frame.png`,it=new Image,it.onload=n,it.onerror=n,it.src=`sprites/rows_frame.png`})}function ot(){p&&(K&&K.complete&&K.naturalWidth>0?p.drawImage(K,V,H,U,W):(p.fillStyle=`#000000`,p.fillRect(V,H,U,W)),p.strokeStyle=`#FFFFFF`,p.lineWidth=e,p.strokeRect(V-1,H-1,U+2,W+2))}function st(t){if(!p)return;let n=V,r=H+7*a,i=U,o=5*a,s=t===`pause`?et:$e;s&&s.complete&&s.naturalWidth>0?p.drawImage(s,n,r,i,o):(p.fillStyle=`#000066`,p.fillRect(n,r,i,o),p.fillStyle=`#FFFFFF`,p.font=`bold ${16*e}px Geneva, Helvetica, sans-serif`,p.textAlign=`center`,p.textBaseline=`middle`,p.fillText(t===`pause`?`PAUSED`:`GAME OVER`,n+i/2,r+o/2),p.textAlign=`left`,p.textBaseline=`alphabetic`)}function ct(){if(m){for(let e=0;e<t;e++)if(m[e]){for(let t=0;t<n;t++)if(m[e][t]){let r=m[e][t]-1;r>=0&&r<7&&ut(V+e*i,H+(n-1-t)*a,r)}}}}function lt(){if(!(!h||!h.grid)){for(let e=0;e<4;e++)for(let r=0;r<4;r++)if(h.grid[e]&&h.grid[e][r]){let o=e+h.offset,s=h.height-r;if(s>=0&&s<n&&o>=0&&o<t){let t=h.grid[e][r]-1;t>=0&&t<7&&ut(V+o*i,H+(n-1-s)*a,t)}}}}function ut(e,t,n){p&&u[n]&&p.drawImage(u[n],e,t,i,a)}function dt(e){!v||y||(e=e.toLowerCase(),!(R||I)&&(h&&(e===`k`&&(Pe(h.color,h.grid),B(h)||Ne(h.color,h.grid)),(e===`i`||e===`arrowup`)&&(Ne(h.color,h.grid),B(h)||Pe(h.color,h.grid)),e===`m`&&!Se&&(N=!0,Se=!0,j=!1,A=!1,M=!1),(e===`j`||e===`arrowleft`)&&(j=!1,A||(A=!0,be=Y(),h.offset--,B(h)||h.offset++)),(e===`l`||e===`arrowright`)&&(A=!1,j||(j=!0,xe=Y(),h.offset++,B(h)||h.offset--))),(e===` `||e===`arrowdown`)&&!F&&!R&&(j=!1,A=!1,F=!0,P=!1,R=!0,Ee=Y())))}function ft(){if(!R||!h)return;let e=Y();e-Ee>=1&&(Ee=e,h.height--,x+=1,B(h)||(--x,h.height++,R=!1,b+=x,x=0,Fe(h)?Ie(!0):vt(),k=Y()))}function pt(e){e=e.toLowerCase(),(e===`j`||e===`arrowleft`)&&(A=!1,M=!1),(e===`l`||e===`arrowright`)&&(j=!1,M=!1),e===`m`&&(N=!1,Se=!1),(e===` `||e===`arrowdown`)&&(F=!1)}function mt(){m=[];for(let e=0;e<t;e++){m[e]=[];for(let t=0;t<n;t++)m[e][t]=0}je(),b=0,x=0,S=0,h=null,g=null,A=!1,j=!1,M=!1,N=!1,P=!1,F=!1,Se=!1,R=!1}function q(e){return document.getElementById(e)}function J(e){return document.getElementById(e)}function ht(e){return document.getElementById(e)}function gt(e){return document.getElementById(e)}function _t(){let e=q(`levelSelect`);C=parseInt(e.value),mt(),v=!0,y=!1,tt=!1,g=Me(_[Math.floor(Math.random()*7)]),Be(),J(`startBtn`).textContent=`Restart`,J(`pauseBtn`).disabled=!1,J(`pauseBtn`).textContent=`Pause`,q(`levelSelect`).disabled=!0,k=Y(),De=performance.now(),Oe=0,Q&&Wt()}function vt(){v=!1,Kt(),$(`gameOver`),J(`startBtn`).textContent=`Begin Game`,J(`pauseBtn`).disabled=!0,q(`levelSelect`).disabled=!1,setTimeout(()=>{xt()},1e3)}function yt(){try{let e=localStorage.getItem(`tetrisMaxHighScores`);if(e)w=JSON.parse(e);else{w=[];for(let e=0;e<_e;e++)w.push({name:`Anonymous`,score:0,rows:0,date:new Date(`1970-01-01`).toISOString()})}}catch(e){console.log(`Failed to load high scores:`,e),w=[]}}function bt(){try{localStorage.setItem(`tetrisMaxHighScores`,JSON.stringify(w))}catch(e){console.log(`Failed to save high scores:`,e)}}async function xt(){if(b!==0){ve=-1;for(let e=0;e<_e;e++)if(b>=w[e].score){ve=e;let t=e,n=b,r=S;z&&z.state===`suspended`&&await z.resume(),$(`highscore`),Tt(t,n,r);return}}}function St(e){try{return new Date(e).toLocaleDateString(`en-UK`,{month:`2-digit`,day:`2-digit`,year:`2-digit`})}catch{return`--`}}function Ct(){if(T=!0,v&&!y&&(y=!0,J(`pauseBtn`).textContent=`Resume`,Z)){try{Z.onended=null,Z.stop()}catch{}Z=null}G()}function wt(){T=!1,G()}function Tt(e,t,n){ye={scoreIndex:e,finalScore:t,finalRows:n};let r=document.getElementById(`highScoreModalOverlay`),i=ht(`highScoreNameInput`),a=J(`startBtn`);document.documentElement.style.setProperty(`--highscore-piece-url`,`url('pieces/${le}.png')`),r&&r.removeAttribute(`hidden`),i&&(i.value=`Player`,i.focus(),i.select()),a&&(a.disabled=!0)}function Et(){if(!ye)return;let{scoreIndex:e,finalScore:t,finalRows:n}=ye;ye=null;let r=ht(`highScoreNameInput`),i={name:r&&r.value&&r.value.trim()?r.value.trim().substring(0,20):`Anonymous`,score:t,rows:n,date:new Date().toISOString()};for(let t=_e-1;t>e;t--)w[t]=w[t-1];w[e]=i,bt();let a=gt(`highScoreModalOverlay`),o=J(`startBtn`);a&&a.setAttribute(`hidden`,``),o&&(o.disabled=!1),Ct()}function Dt(){if(D=!0,v&&!y&&(y=!0,J(`pauseBtn`).textContent=`Resume`,Z)){try{Z.onended=null,Z.stop()}catch{}Z=null}G()}function Ot(){D=!1,G()}function kt(){if(!D||!f||!p)return;let t=477*e,n=244*e,r=t+6*e+6*e,i=n+6*e+6*e,a=e*Math.floor((f.width-r)/2/e),o=e*Math.floor((f.height-i)/2/e);p.fillStyle=`#000000`,p.fillRect(a+2*e,o+2*e,r-e,i-e),p.fillStyle=`#000000`,p.fillRect(a,o,r,i);let s={topLeft:[`#000000`,`#BBBBBB`,`#FFFFFF`],bottomRight:[`#000000`,`#555555`,`#999999`]};for(let t=0;t<3;t++){let n=t;p.fillStyle=s.topLeft[t],p.fillRect(a+n*e,o+n*e,r-n*2*e,e),p.fillRect(a+n*e,o+n*e,e,i-n*2*e),p.fillStyle=s.bottomRight[t],p.fillRect(a+n*e,o+i-n*e-e,r-n*2*e,e),p.fillRect(a+r-n*e-e,o+n*e,e,i-n*2*e)}let c=a+3*e+3*e,l=o+3*e+3*e;O&&O.complete&&O.naturalWidth>0&&p.drawImage(O,c,l,t,n)}function At(){if(!T||!f||!p)return;let t=452*e,n=308*e,r=(f.width-t)/2,i=(f.height-n)/2;p.fillStyle=`#000000`,p.fillRect(r+2*e,i+2*e,t-e,n-e),p.fillStyle=`#000000`,p.fillRect(r,i,t,n);let a={topLeft:[`#000000`,`#BBBBBB`,`#FFFFFF`],bottomRight:[`#000000`,`#555555`,`#999999`]};for(let o=0;o<3;o++){let s=o;p.fillStyle=a.topLeft[o],p.fillRect(r+s*e,i+s*e,t-s*2*e,e),p.fillRect(r+s*e,i+s*e,e,n-s*2*e),p.fillStyle=a.bottomRight[o],p.fillRect(r+s*e,i+n-s*e-e,t-s*2*e,e),p.fillRect(r+t-s*e-e,i+s*e,e,n-s*2*e)}p.fillStyle=`#000000`,p.fillRect(r+3*e,i+3*e,t-6*e,n-6*e);let o=3*e,s=r+o,c=i+o;if(E&&E.complete&&E.naturalWidth>0){let t=s+109*e+3*e,n=c+3*e;p.drawImage(E,t,n,220*e,50*e)}p.fillStyle=`#FFFFFF`,p.font=`${15*e}px "Times New Roman", serif`;let l=c+62*e,ee=22*e,te=s+14*e,ne=s+256*e,re=s+320*e,ie=s+335*e;p.textAlign=`left`,p.fillText(`Name`,te,l);let{width:ae}=p.measureText(`Name`);p.fillRect(te,l+e,ae,e),p.textAlign=`right`,p.fillText(`Score`,ne,l);let{width:oe}=p.measureText(`Score`);p.fillRect(ne-oe,l+e,oe,e),p.fillText(`Rows`,re,l);let{width:se}=p.measureText(`Rows`);p.fillRect(re-se,l+e,se,e),p.textAlign=`left`,p.fillText(`Date`,ie,l);let{width:ce}=p.measureText(`Date`);p.fillRect(ie,l+e,ce,e),p.font=`${15*e}px "Times New Roman", serif`;for(let t=0;t<_e;t++){let n=w[t],r=l+(t+1)*ee+3*e;t===ve?p.fillStyle=`#FFFF00`:p.fillStyle=`#FFFFFF`,p.textAlign=`left`,p.fillText(`${t+1}. ${n.name}`,te,r),p.textAlign=`right`,p.fillText(String(n.score),ne,r),p.fillText(String(n.rows),re,r),p.textAlign=`left`,p.fillText(St(n.date),ie,r)}p.textAlign=`left`}function jt(){if(v){if(y=!y,J(`pauseBtn`).textContent=y?`Resume`:`Pause`,y){if($(`pause`),Z){try{Z.onended=null,Z.stop()}catch{}Z=null}}else k=Y(),T&&=!1,D&&=!1,Q&&Pt.length>0&&Wt();G()}}var Mt=0;function Y(){return Mt}function Nt(e){let t=e-De;for(De=e,Oe+=t;Oe>=o;)Mt++,Oe-=o,v&&!y&&(I?Y()-Ce>=Te&&Le():R?ft():Ve());G(),requestAnimationFrame(Nt)}var Pt=[],Ft=[],X=0,It=0,Lt=0,Z=null,Rt=null,Q=!0,zt=!0,Bt={peter_wagner:{prefix:`peter_wagner`,segments:[`repeat`,`repeat`,`CD`,`repeat`,`repeat`,`E`,`E`,`Fa`,`Fb`,`Fc`,`repeat`,`repeat`,`E`,`Fb`,`G`],repeatSegment:0,folder:`music`},animal_instinct:{prefix:`animal_instinct`,segments:[`A`],repeatSegment:0,folder:`music`}},Vt=!1;async function Ht(){try{z=new window.AudioContext({latencyHint:`interactive`});let e=Object.keys(ke);for(let t of e)try{let e=ke[t],n=await(await fetch(e)).arrayBuffer();Ae[t]=await z.decodeAudioData(n)}catch(e){console.log(`Failed to load sound: ${t}`,e)}console.log(`Loaded ${Object.keys(Ae).length} sounds`),await Ut(de)}catch(e){console.log(`Audio not available:`,e)}}async function Ut(e){let t=Bt[e];if(!t){console.warn(`Unknown music style: ${e}`);return}if(!z)return;Ft=t.segments,It=t.repeatSegment,Lt=t.segments.length-1;let n=[...new Set(Ft)],r={};for(let e of n)try{let n=await(await fetch(`${t.folder}/${t.prefix}_${e}.wav`)).arrayBuffer();r[e]=await z.decodeAudioData(n)}catch(t){console.log(`Failed to load music segment: ${e}`,t),r[e]=null}Pt=Ft.map(e=>r[e]||null),console.log(`Loaded music style: ${e} (${Object.keys(r).filter(e=>r[e]).length} segments)`)}function Wt(){!z||!Q||Pt.length===0||(z.state===`suspended`&&z.resume(),X=0,Vt=!0,Gt())}function Gt(){if(!Vt||!Q||y||!z)return;(X>=Pt.length||X<0)&&(X=It);let e=Pt[X];if(!e){X===Lt?X=It:X++,Gt();return}if(Z)try{Z.onended=null,Z.stop()}catch{}Z=z.createBufferSource(),Z.buffer=e,Rt=z.createGain(),Rt.gain.value=.3,Z.connect(Rt),Rt.connect(z.destination),Z.onended=()=>{Vt&&Q&&(X===Lt?X=It:X++,Gt())},Z.start(0)}function Kt(){if(Vt=!1,Z){try{Z.onended=null,Z.stop()}catch{}Z=null}}function qt(){Q=!Q,Q&&v&&!y?Wt():Kt();let e=document.getElementById(`musicBtn`);e&&(e.textContent=Q?`Music: ON`:`Music: OFF`)}function Jt(){zt=!zt;let e=document.getElementById(`soundBtn`);e&&(e.textContent=zt?`Sound Effects: ON`:`Sound Effects: OFF`)}function $(e){if(!z||!Ae[e]||!zt)return;z.state===`suspended`&&z.resume();let t=z.createBufferSource();t.buffer=Ae[e];let n=z.createGain();n.gain.value=.5,t.connect(n),n.connect(z.destination),t.start(z.currentTime+.01)}async function Yt(){if(f=document.getElementById(`gameCanvas`),p=f.getContext(`2d`),!p){console.error(`Could not get context`);return}f.width=r.WINDOW_WIDTH*e,f.height=r.WINDOW_HEIGHT*e,p.imageSmoothingEnabled=!1,p.fillStyle=`#000000`,p.fillRect(0,0,f.width,f.height),p.fillStyle=`#FFFFFF`,p.font=`${12*e}px Geneva, Helvetica, sans-serif`,p.fillText(`Loading assets...`,20,f.height/2),await pe(),await ge(),await at(),await Ht(),mt(),yt(),document.addEventListener(`keydown`,e=>{if([`ArrowLeft`,`ArrowRight`,`ArrowDown`,`ArrowUp`,`Space`,`KeyJ`,`KeyL`,`KeyK`,`KeyI`,`KeyM`,`KeyP`].includes(e.code)&&e.preventDefault(),e.code===`KeyP`){jt();return}dt(e.key)}),document.addEventListener(`keyup`,e=>{pt(e.key)}),f.addEventListener(`click`,()=>{T&&wt(),D&&Ot()}),J(`startBtn`).addEventListener(`click`,()=>{z&&z.state===`suspended`&&z.resume(),T&&wt(),D&&Ot(),_t()}),J(`pauseBtn`).addEventListener(`click`,jt),J(`musicBtn`).addEventListener(`click`,qt),J(`soundBtn`).addEventListener(`click`,Jt),J(`highScoresBtn`).addEventListener(`click`,()=>{T?wt():(Ot(),ve=-1,Ct())}),J(`aboutBtn`).addEventListener(`click`,()=>{D?Ot():(wt(),Dt())});let t=document.getElementById(`highScoreModalOverlay`),n=document.getElementById(`highScoreNameInput`),i=document.getElementById(`highScoreModalOk`);i&&i.addEventListener(`click`,Et),n&&n.addEventListener(`keydown`,e=>{e.key===`Enter`&&Et()}),t&&t.addEventListener(`click`,e=>{e.target===t&&Et()}),q(`piecesSelect`).addEventListener(`change`,async e=>{le=e?.target?.value,await pe(le),G()}),q(`backgroundSelect`).addEventListener(`change`,async e=>{ue=e?.target?.value,await me(ue),G()}),q(`musicSelect`).addEventListener(`change`,async e=>{let t=Vt;t&&Kt();let n=e?.target?.value;(n===`peter_wagner`||n===`animal_instinct`)&&(de=n),await Ut(de),t&&v&&!y&&Wt()}),G(),De=performance.now(),requestAnimationFrame(Nt)}document.addEventListener(`DOMContentLoaded`,Yt);